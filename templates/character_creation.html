{% extends "base.html" %}

{% block head %}
<link rel="stylesheet" href="{{ url_for('static', filename='character_creation.css') }}">
{% endblock %}

{% block title %}Cr√©er un personnage - D&D{% endblock %}

{% block content %}
<div class="character-creation-layout">
    <div class="character-creation-container">
    <!-- Indicateur de progression -->
    <div class="progress-indicator">
        <div class="step active" data-step="1">
            <div class="step-number">1</div>
            <div class="step-title">Classe</div>
        </div>
        <div class="step" data-step="2">
            <div class="step-number">2</div>
            <div class="step-title">Race</div>
        </div>
        <div class="step" data-step="3">
            <div class="step-number">3</div>
            <div class="step-title">D√©tails</div>
        </div>
        <div class="step" data-step="4">
            <div class="step-number">4</div>
            <div class="step-title">Sorts & Combat</div>
        </div>
        <div class="step" data-step="5">
            <div class="step-number">5</div>
            <div class="step-title">√âquipement</div>
        </div>
        <div class="step" data-step="6">
            <div class="step-number">6</div>
            <div class="step-title">Finalisation</div>
        </div>
    </div>

    <!-- Formulaire de cr√©ation -->
    <form id="characterForm" method="POST" action="{{ url_for('create_character') }}">
        <!-- √âtape 1: Choix de la Classe -->
        <div class="step-content active" data-step="1">
            <h2>Choisissez votre classe</h2>
            <div class="classes-grid">
                <div class="class-card" data-class="barbare">
                    <div class="class-icon">‚öîÔ∏è</div>
                    <h3>Barbare</h3>
                    <p>Guerrier sauvage, puissance brute</p>
                    <div class="class-stats">
                        <span>DV: d12</span>
                        <span>Ma√Ætrises: Force, Constitution</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="barde">
                    <div class="class-icon">üéµ</div>
                    <h3>Barde</h3>
                    <p>Ma√Ætre des mots et de la magie</p>
                    <div class="class-stats">
                        <span>DV: d8</span>
                        <span>Ma√Ætrises: Dext√©rit√©, Charisme</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="clerc">
                    <div class="class-icon">‚ú®</div>
                    <h3>Clerc</h3>
                    <p>Champion divin, gu√©risseur</p>
                    <div class="class-stats">
                        <span>DV: d8</span>
                        <span>Ma√Ætrises: Sagesse, Charisme</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="druide">
                    <div class="class-icon">üåø</div>
                    <h3>Druide</h3>
                    <p>Gardien de la nature</p>
                    <div class="class-stats">
                        <span>DV: d8</span>
                        <span>Ma√Ætrises: Intelligence, Sagesse</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="ensorceleur">
                    <div class="class-icon">‚ö°</div>
                    <h3>Ensorceleur</h3>
                    <p>Magie inn√©e, pouvoir brut</p>
                    <div class="class-stats">
                        <span>DV: d6</span>
                        <span>Ma√Ætrises: Constitution, Charisme</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="guerrier">
                    <div class="class-icon">üõ°Ô∏è</div>
                    <h3>Guerrier</h3>
                    <p>Ma√Ætre des armes et tactiques</p>
                    <div class="class-stats">
                        <span>DV: d10</span>
                        <span>Ma√Ætrises: Force, Constitution</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="magicien">
                    <div class="class-icon">üîÆ</div>
                    <h3>Magicien</h3>
                    <p>√ârudit de la magie arcanique</p>
                    <div class="class-stats">
                        <span>DV: d6</span>
                        <span>Ma√Ætrises: Intelligence, Sagesse</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="moine">
                    <div class="class-icon">üë§</div>
                    <h3>Moine</h3>
                    <p>Ma√Ætre des arts martiaux</p>
                    <div class="class-stats">
                        <span>DV: d8</span>
                        <span>Ma√Ætrises: Force, Dext√©rit√©</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="paladin">
                    <div class="class-icon">‚öîÔ∏è</div>
                    <h3>Paladin</h3>
                    <p>Guerrier sacr√©, protecteur</p>
                    <div class="class-stats">
                        <span>DV: d10</span>
                        <span>Ma√Ætrises: Sagesse, Charisme</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="rodeur">
                    <div class="class-icon">üèπ</div>
                    <h3>R√¥deur</h3>
                    <p>Traqueur, chasseur</p>
                    <div class="class-stats">
                        <span>DV: d10</span>
                        <span>Ma√Ætrises: Force, Dext√©rit√©</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="roublard">
                    <div class="class-icon">üó°Ô∏è</div>
                    <h3>Roublard</h3>
                    <p>Espion, voleur, assassin</p>
                    <div class="class-stats">
                        <span>DV: d8</span>
                        <span>Ma√Ætrises: Dext√©rit√©, Intelligence</span>
                    </div>
                </div>
                
                <div class="class-card" data-class="sorcier">
                    <div class="class-icon">üëÅÔ∏è</div>
                    <h3>Sorcier</h3>
                    <p>Serviteur de puissances obscures</p>
                    <div class="class-stats">
                        <span>DV: d8</span>
                        <span>Ma√Ætrises: Sagesse, Charisme</span>
                    </div>
                </div>
            </div>
            
            <input type="hidden" name="selected_class" id="selectedClass">
            
            <div class="navigation-buttons">
                <div></div> <!-- Espaceur pour pousser le bouton √† droite -->
                <button type="button" class="nav-button next" onclick="nextStep()">Suivant</button>
            </div>
        </div>

        <!-- √âtape 2: Choix de la Race -->
        <div class="step-content" data-step="2">
            <h2>Choisissez votre race</h2>
            
            <div class="race-categories">
                <div class="category-header">
                    <h3>Races principales</h3>
                </div>
                <div class="races-grid">
                    <div class="race-card" data-race="humain">
                        <div class="race-icon">üë§</div>
                        <h4>Humain</h4>
                        <p>Polyvalent et adaptable</p>
                        <div class="race-stats">
                            <span>+1 toutes caract√©ristiques</span>
                            <span>Vitesse: 9m</span>
                        </div>
                    </div>
                    
                    <div class="race-card" data-race="elfe">
                        <div class="race-icon">üßù</div>
                        <h4>Elfe</h4>
                        <p>Gracieux et magique</p>
                        <div class="race-stats">
                            <span>+2 Dext√©rit√©</span>
                            <span>Vision dans le noir</span>
                        </div>
                    </div>
                    
                    <div class="race-card" data-race="nain">
                        <div class="race-icon">üèîÔ∏è</div>
                        <h4>Nain</h4>
                        <p>R√©sistant et d√©termin√©</p>
                        <div class="race-stats">
                            <span>+2 Constitution</span>
                            <span>R√©sistance aux poisons</span>
                        </div>
                    </div>
                    
                    <div class="race-card" data-race="halfelin">
                        <div class="race-icon">üåæ</div>
                        <h4>Halfelin</h4>
                        <p>Petit mais courageux</p>
                        <div class="race-stats">
                            <span>+2 Dext√©rit√©</span>
                            <span>Chance extraordinaire</span>
                        </div>
                    </div>
                    
                    <div class="race-card" data-race="gnome">
                        <div class="race-icon">üé≠</div>
                        <h4>Gnome</h4>
                        <p>Curieux et inventif</p>
                        <div class="race-stats">
                            <span>+2 Intelligence</span>
                            <span>Magie mineure</span>
                        </div>
                    </div>
                    
                    <div class="race-card" data-race="demi-elfe">
                        <div class="race-icon">üßù‚Äç‚ôÇÔ∏è</div>
                        <h4>Demi-elfe</h4>
                        <p>H√©ritage mixte</p>
                        <div class="race-stats">
                            <span>+2 Charisme, +1 deux autres</span>
                            <span>Comp√©tences vari√©es</span>
                        </div>
                    </div>
                    
                    <div class="race-card" data-race="demi-orc">
                        <div class="race-icon">üí™</div>
                        <h4>Demi-orc</h4>
                        <p>Force et endurance</p>
                        <div class="race-stats">
                            <span>+2 Force, +1 Constitution</span>
                            <span>Endurance implacable</span>
                        </div>
                    </div>
                </div>
                
                <div class="category-header">
                    <h3>Races exceptionnelles</h3>
                </div>
                <div class="races-grid">
                    <div class="race-card" data-race="tieffelin">
                        <div class="race-icon">üòà</div>
                        <h4>Tieffelin</h4>
                        <p>H√©ritage infernal</p>
                        <div class="race-stats">
                            <span>+2 Charisme, +1 Intelligence</span>
                            <span>Magie infernale</span>
                        </div>
                    </div>
                    
                    <div class="race-card" data-race="aasimar">
                        <div class="race-icon">üòá</div>
                        <h4>Aasimar</h4>
                        <p>Touch√© par le divin</p>
                        <div class="race-stats">
                            <span>+2 Charisme</span>
                            <span>Gu√©rison naturelle</span>
                        </div>
                    </div>
                    
                    <div class="race-card" data-race="sangdragon">
                        <div class="race-icon">üêâ</div>
                        <h4>Sangdragon</h4>
                        <p>Descendant de dragon</p>
                        <div class="race-stats">
                            <span>+2 Force, +1 Charisme</span>
                            <span>Souffle draconique</span>
                        </div>
                    </div>
                    
                    <div class="race-card" data-race="felys">
                        <div class="race-icon">üê±</div>
                        <h4>F√©lys</h4>
                        <p>Agilit√© f√©line</p>
                        <div class="race-stats">
                            <span>+2 Dext√©rit√©, +1 Charisme</span>
                            <span>Gr√¢ce du chat</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <input type="hidden" name="selected_race" id="selectedRace">
            <input type="hidden" name="racial_choices" id="racialChoicesInput">
            
            <div class="navigation-buttons">
                <button type="button" class="nav-button prev" onclick="prevStep()">Pr√©c√©dent</button>
                <button type="button" class="nav-button next" onclick="nextStep()">Suivant</button>
            </div>
        </div>

        <!-- √âtape 3: Caract√©ristiques et Historique -->
        <div class="step-content" data-step="3">
            <h2>Finaliser votre personnage</h2>
            
            <div class="character-details">
                <div class="section">
                    <h3>Informations de base</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="characterName">Nom du personnage</label>
                            <input type="text" id="characterName" name="character_name" required>
                        </div>
                        <div class="form-group">
                            <label for="characterLevel">Niveau</label>
                            <select id="characterLevel" name="character_level">
                                <option value="1" selected>1</option>
                                <option value="2">2</option>
                                <option value="3">3</option>
                                <option value="4">4</option>
                                <option value="5">5</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- Section des r√®gles d'incantation -->
                <div id="incantation-rules-container" class="section" style="display: none;">
                    <!-- Les r√®gles d'incantation seront ajout√©es ici dynamiquement -->
                </div>
                
                <div class="section">
                    <h3>Caract√©ristiques</h3>
                    <div class="abilities-grid">
                        <div class="ability-score">
                            <label>Force</label>
                            <div class="score-input">
                                <button type="button" class="score-btn" onclick="adjustScore('force', -1)">-</button>
                                <input type="number" id="force" name="force" value="10" min="8" max="15">
                                <button type="button" class="score-btn" onclick="adjustScore('force', 1)">+</button>
                            </div>
                            <div class="score-final">
                                <span id="force-final-score" style="display: none;"></span>
                            </div>
                            <div class="modifier" id="force-mod">+0</div>
                            <div class="race-bonus" id="force-bonus"></div>
                            <div class="racial-choice-inline" id="force-choice" style="display: none;">
                                <label class="choice-checkbox">
                                    <input type="checkbox" name="racial_choice_force" onchange="handleInlineRacialChoice(this, 'force')">
                                    <span>+1 Demi-elfe</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="ability-score">
                            <label>Dext√©rit√©</label>
                            <div class="score-input">
                                <button type="button" class="score-btn" onclick="adjustScore('dexterite', -1)">-</button>
                                <input type="number" id="dexterite" name="dexterite" value="10" min="8" max="15">
                                <button type="button" class="score-btn" onclick="adjustScore('dexterite', 1)">+</button>
                            </div>
                            <div class="score-final">
                                <span id="dexterite-final-score" style="display: none;"></span>
                            </div>
                            <div class="modifier" id="dexterite-mod">+0</div>
                            <div class="race-bonus" id="dexterite-bonus"></div>
                            <div class="racial-choice-inline" id="dexterite-choice" style="display: none;">
                                <label class="choice-checkbox">
                                    <input type="checkbox" name="racial_choice_dexterite" onchange="handleInlineRacialChoice(this, 'dexterite')">
                                    <span>+1 Demi-elfe</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="ability-score">
                            <label>Constitution</label>
                            <div class="score-input">
                                <button type="button" class="score-btn" onclick="adjustScore('constitution', -1)">-</button>
                                <input type="number" id="constitution" name="constitution" value="10" min="8" max="15">
                                <button type="button" class="score-btn" onclick="adjustScore('constitution', 1)">+</button>
                            </div>
                            <div class="score-final">
                                <span id="constitution-final-score" style="display: none;"></span>
                            </div>
                            <div class="modifier" id="constitution-mod">+0</div>
                            <div class="race-bonus" id="constitution-bonus"></div>
                            <div class="racial-choice-inline" id="constitution-choice" style="display: none;">
                                <label class="choice-checkbox">
                                    <input type="checkbox" name="racial_choice_constitution" onchange="handleInlineRacialChoice(this, 'constitution')">
                                    <span>+1 Demi-elfe</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="ability-score">
                            <label>Intelligence</label>
                            <div class="score-input">
                                <button type="button" class="score-btn" onclick="adjustScore('intelligence', -1)">-</button>
                                <input type="number" id="intelligence" name="intelligence" value="10" min="8" max="15">
                                <button type="button" class="score-btn" onclick="adjustScore('intelligence', 1)">+</button>
                            </div>
                            <div class="score-final">
                                <span id="intelligence-final-score" style="display: none;"></span>
                            </div>
                            <div class="modifier" id="intelligence-mod">+0</div>
                            <div class="race-bonus" id="intelligence-bonus"></div>
                            <div class="racial-choice-inline" id="intelligence-choice" style="display: none;">
                                <label class="choice-checkbox">
                                    <input type="checkbox" name="racial_choice_intelligence" onchange="handleInlineRacialChoice(this, 'intelligence')">
                                    <span>+1 Demi-elfe</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="ability-score">
                            <label>Sagesse</label>
                            <div class="score-input">
                                <button type="button" class="score-btn" onclick="adjustScore('sagesse', -1)">-</button>
                                <input type="number" id="sagesse" name="sagesse" value="10" min="8" max="15">
                                <button type="button" class="score-btn" onclick="adjustScore('sagesse', 1)">+</button>
                            </div>
                            <div class="score-final">
                                <span id="sagesse-final-score" style="display: none;"></span>
                            </div>
                            <div class="modifier" id="sagesse-mod">+0</div>
                            <div class="race-bonus" id="sagesse-bonus"></div>
                            <div class="racial-choice-inline" id="sagesse-choice" style="display: none;">
                                <label class="choice-checkbox">
                                    <input type="checkbox" name="racial_choice_sagesse" onchange="handleInlineRacialChoice(this, 'sagesse')">
                                    <span>+1 Demi-elfe</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="ability-score">
                            <label>Charisme</label>
                            <div class="score-input">
                                <button type="button" class="score-btn" onclick="adjustScore('charisme', -1)">-</button>
                                <input type="number" id="charisme" name="charisme" value="10" min="8" max="15">
                                <button type="button" class="score-btn" onclick="adjustScore('charisme', 1)">+</button>
                            </div>
                            <div class="score-final">
                                <span id="charisme-final-score" style="display: none;"></span>
                            </div>
                            <div class="modifier" id="charisme-mod">+0</div>
                            <div class="race-bonus" id="charisme-bonus"></div>
                            <div class="racial-choice-inline" id="charisme-choice" style="display: none;">
                                <label class="choice-checkbox">
                                    <input type="checkbox" name="racial_choice_charisme" onchange="handleInlineRacialChoice(this, 'charisme')">
                                    <span>+1 Demi-elfe</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="points-remaining">
                        Points restants: <span id="pointsRemaining">27</span>
                    </div>
                    <div class="ability-rules">
                        <p><em>R√©partissez 27 points entre vos caract√©ristiques (co√ªt : 8-13 = 1pt/niveau, 14 = 2pts, 15 = 2pts). Les bonus raciaux s'ajoutent ensuite.</em></p>
                    </div>
                    

                    

                </div>
                
                <div class="section">
                    <h3>Historique</h3>
                    <div id="backgrounds-loading" class="loading-message">
                        <p>Chargement des historiques...</p>
                    </div>
                    <div id="backgrounds-container" style="display: none;">
                        <div class="backgrounds-grid" id="backgrounds-grid">
                            <!-- Les historiques seront charg√©s dynamiquement -->
                        </div>
                        
                        <!-- Bouton pour voir les variantes (optionnel) -->
                        <div id="show-variants-button" style="display: none; text-align: center; margin-top: 1rem;">
                            <button type="button" class="nav-button" onclick="toggleVariants()">
                                Voir les variantes disponibles
                            </button>
                        </div>
                        
                        <!-- S√©lection des variantes (masqu√©e par d√©faut) -->
                        <div id="variant-selection" class="variant-section" style="display: none;">
                            <h4>Variantes disponibles</h4>
                            <p style="font-size: 0.9rem; color: var(--text-light); margin-bottom: 1rem;">
                                <em>Optionnel : Choisissez une variante pour personnaliser votre historique</em>
                            </p>
                            <div id="variants-grid" class="variants-grid">
                                <!-- Les variantes seront charg√©es dynamiquement -->
                            </div>
                            <div style="text-align: center; margin-top: 1rem;">
                                <button type="button" class="nav-button prev" onclick="selectBaseBackground()">
                                    Utiliser l'historique de base
                                </button>
                            </div>
                        </div>
                        
                        <!-- D√©tails de l'historique s√©lectionn√© -->
                        <div id="background-details" class="background-details" style="display: none;">
                            <h4>D√©tails de l'historique</h4>
                            
                            <!-- Aptitude principale -->
                            <div id="background-ability-section" class="ability-section" style="display: none;">
                                <h5>Aptitude</h5>
                                <div class="ability-card">
                                    <h6 id="ability-name"></h6>
                                    <div id="ability-description"></div>
                                </div>
                            </div>
                            
                            <!-- Sections sp√©ciales -->
                            <div id="background-special-sections" class="special-sections">
                                <!-- Sections sp√©ciales g√©n√©r√©es dynamiquement -->
                            </div>
                            
                            <!-- Sections de choix interactives -->
                            <div id="background-choice-sections" class="choice-sections">
                                <!-- Sections de choix g√©n√©r√©es dynamiquement -->
                            </div>
                            
                            <div class="background-info-grid">
                                <div class="info-section">
                                    <h5>Comp√©tences ma√Ætris√©es</h5>
                                    <div id="background-skills-display"></div>
                                </div>
                                <div class="info-section">
                                    <h5>Outils ma√Ætris√©s</h5>
                                    <div id="background-tools-display"></div>
                                </div>
                                <div class="info-section">
                                    <h5>Langues</h5>
                                    <div id="background-languages-display"></div>
                                </div>
                                <div class="info-section">
                                    <h5>√âquipement</h5>
                                    <div id="background-equipment-display"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Section Traits de personnalit√© -->
                <div class="section" id="personality-section" style="display: none;">
                    <h3>Traits de personnalit√©</h3>
                    <p class="personality-description">Vous pouvez √©crire vos propres traits ou utiliser les suggestions de votre historique.</p>
                    
                    <div class="personality-fields">
                        <div class="personality-field">
                            <label for="trait-input">Trait de personnalit√©</label>
                            <div class="input-with-suggestions">
                                <textarea id="trait-input" name="personality_trait" placeholder="D√©crivez un trait de caract√®re de votre personnage..." maxlength="200"></textarea>
                                <div class="suggestions-container">
                                    <button type="button" class="suggestions-toggle" onclick="toggleSuggestions('trait')">
                                        <span>Voir les suggestions</span> <span class="dice-icon">üé≤</span>
                                    </button>
                                    <div id="trait-suggestions" class="suggestions-list" style="display: none;">
                                        <!-- Suggestions g√©n√©r√©es dynamiquement -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="personality-field">
                            <label for="ideal-input">Id√©al</label>
                            <div class="input-with-suggestions">
                                <textarea id="ideal-input" name="ideal" placeholder="Quel principe guide votre personnage?..." maxlength="200"></textarea>
                                <div class="suggestions-container">
                                    <button type="button" class="suggestions-toggle" onclick="toggleSuggestions('ideal')">
                                        <span>Voir les suggestions</span> <span class="dice-icon">üé≤</span>
                                    </button>
                                    <div id="ideal-suggestions" class="suggestions-list" style="display: none;">
                                        <!-- Suggestions g√©n√©r√©es dynamiquement -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="personality-field">
                            <label for="bond-input">Lien</label>
                            <div class="input-with-suggestions">
                                <textarea id="bond-input" name="bond" placeholder="Qui ou quoi est important pour votre personnage?..." maxlength="200"></textarea>
                                <div class="suggestions-container">
                                    <button type="button" class="suggestions-toggle" onclick="toggleSuggestions('bond')">
                                        <span>Voir les suggestions</span> <span class="dice-icon">üé≤</span>
                                    </button>
                                    <div id="bond-suggestions" class="suggestions-list" style="display: none;">
                                        <!-- Suggestions g√©n√©r√©es dynamiquement -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="personality-field">
                            <label for="flaw-input">D√©faut</label>
                            <div class="input-with-suggestions">
                                <textarea id="flaw-input" name="flaw" placeholder="Quel vice ou faiblesse anime votre personnage?..." maxlength="200"></textarea>
                                <div class="suggestions-container">
                                    <button type="button" class="suggestions-toggle" onclick="toggleSuggestions('flaw')">
                                        <span>Voir les suggestions</span> <span class="dice-icon">üé≤</span>
                                    </button>
                                    <div id="flaw-suggestions" class="suggestions-list" style="display: none;">
                                        <!-- Suggestions g√©n√©r√©es dynamiquement -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Section des comp√©tences de classe -->
                <div class="section" id="class-skills-section-container" style="display: none;">
                    <h3>Comp√©tences de classe</h3>
                    <div id="background-skills-summary" class="skills-summary" style="display: none;">
                        <h4>Comp√©tences acquises par votre historique :</h4>
                        <div id="background-skills-list" class="skills-acquired"></div>
                    </div>
                    
                    <div id="background-skill-choices" class="skill-choices-section" style="display: none;">
                        <h4>Choix de comp√©tences d'historique :</h4>
                        <div id="background-skill-choices-list">
                            <!-- Choix g√©n√©r√©s dynamiquement -->
                        </div>
                    </div>
                    <div id="class-skills-section">
                        <p>S√©lectionnez un historique pour voir les comp√©tences de classe disponibles</p>
                    </div>
                </div>
                
                <input type="hidden" name="selected_background" id="selectedBackground">
                <input type="hidden" name="selected_variant" id="selectedVariant">
                <input type="hidden" name="class_skills" id="classSkillsInput">
                <input type="hidden" name="racial_choices" id="racialChoicesInput">
                <input type="hidden" name="background_choices" id="backgroundChoicesInput">
                <input type="hidden" name="background_skill_choices" id="backgroundSkillChoicesInput">
                <input type="hidden" name="selected_subclass" id="selectedSubclassInput">
                <input type="hidden" name="selected_multiclass" id="selectedMulticlassInput">
                <input type="hidden" name="progression_choice" id="progressionChoiceInput">
                <input type="hidden" name="selected_spells" id="selectedSpellsInput">
                <input type="hidden" name="selected_armor" id="selectedArmorInput">
                <input type="hidden" name="selected_shield" id="selectedShieldInput">
                <input type="hidden" name="selected_main_weapon" id="selectedMainWeaponInput">
                <input type="hidden" name="selected_secondary_weapon" id="selectedSecondaryWeaponInput">
                <input type="hidden" name="selected_backup_weapon" id="selectedBackupWeaponInput">
                <input type="hidden" name="selected_inventory" id="selectedInventoryInput">
            </div>
            
            <div class="navigation-buttons">
                <button type="button" class="nav-button prev" onclick="prevStep()">Pr√©c√©dent</button>
                <button type="button" class="nav-button next" onclick="nextStep()">Suivant</button>
            </div>
        </div>

        <!-- Popup de choix de progression -->
        <div id="progressionChoiceModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>üéØ Choix de progression</h3>
                    <p>Vous avez atteint un niveau qui vous permet de faire des choix importants !</p>
                </div>
                
                <div class="modal-body">
                    <div class="progression-options">
                        <!-- Option: Continuer avec une seule classe -->
                        <div class="progression-option" id="singleClassOption">
                            <div class="option-header">
                                <div class="option-icon">üìà</div>
                                <h4>Continuer avec une seule classe</h4>
                            </div>
                            <p>Progresser normalement dans votre classe actuelle et d√©bloquer toutes ses capacit√©s.</p>
                            <button type="button" class="option-button" onclick="chooseProgression('single')">
                                Choisir cette option
                            </button>
                        </div>
                        
                        <!-- Option: Choisir une sous-classe -->
                        <div class="progression-option" id="subclassOption" style="display: none;">
                            <div class="option-header">
                                <div class="option-icon">üé≠</div>
                                <h4>Choisir une sp√©cialisation</h4>
                            </div>
                            <p>S√©lectionner une sous-classe pour sp√©cialiser votre personnage.</p>
                            <div id="subclassesList" class="subclasses-list">
                                <!-- Les sous-classes seront charg√©es ici -->
                            </div>
                        </div>
                        
                        <!-- Option: Multiclassing -->
                        <div class="progression-option" id="multiclassOption" style="display: none;">
                            <div class="option-header">
                                <div class="option-icon">üé≠</div>
                                <h4>Multiclassing</h4>
                            </div>
                            <p>Combiner votre classe actuelle avec une nouvelle classe pour plus de polyvalence.</p>
                            <div class="multiclass-warning">
                                <p><strong>‚ö†Ô∏è Attention :</strong> Le multiclassing peut ralentir la progression de votre classe principale.</p>
                            </div>
                            <div id="multiclassList" class="multiclass-list">
                                <!-- Les classes disponibles seront charg√©es ici -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="modal-button secondary" onclick="closeProgressionModal()">
                        Annuler
                    </button>
                    <button type="button" class="modal-button primary" id="confirmProgressionBtn" onclick="confirmProgression()" disabled>
                        Confirmer le choix
                    </button>
                </div>
            </div>
        </div>

        <!-- Modal de d√©tails de sous-classe -->
        <div id="subclassDetailsModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="subclassDetailsTitle">D√©tails de la sous-classe</h3>
                    <button type="button" class="modal-close" onclick="closeSubclassDetails()">√ó</button>
                </div>
                
                <div class="modal-body">
                    <div id="subclassDetailsContent">
                        <div class="subclass-details-description">
                            <h4>üìñ Description</h4>
                            <p id="subclassDetailsDescription">-</p>
                        </div>
                        
                        <div class="subclass-details-abilities">
                            <h4>‚öîÔ∏è Aptitudes de la sous-classe</h4>
                            <div id="subclassAbilitiesList">
                                <!-- Les aptitudes seront charg√©es ici -->
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="modal-button secondary" onclick="closeSubclassDetails()">
                        Fermer
                    </button>
                    <button type="button" class="modal-button primary" id="selectSubclassFromModal" onclick="selectSubclassFromDetails()">
                        Choisir cette sous-classe
                    </button>
                </div>
            </div>
        </div>

        <!-- √âtape 4: Sorts et Comp√©tences de Combat -->
        <div class="step-content" data-step="4">
            <h2>S√©lection des sorts et comp√©tences de combat</h2>
            
            <!-- Loading indicator -->
            <div id="loadingSpells" class="loading-indicator" style="display: none;">
                <div class="spinner"></div>
                <p>Chargement des sorts et comp√©tences...</p>
            </div>
            
            <!-- Onglets de navigation -->
            <div class="tabs-container">
                <div class="tabs-nav">
                    <button class="tab-button active" data-tab="spells">
                        <span class="tab-icon">‚ú®</span>
                        Sorts disponibles
                    </button>
                    <button class="tab-button" data-tab="combat-abilities">
                        <span class="tab-icon">‚öîÔ∏è</span>
                        Aptitudes de combat
                    </button>
                    <button class="tab-button" data-tab="racial-traits">
                        <span class="tab-icon">üß¨</span>
                        Traits raciaux
                    </button>
                </div>
            </div>
            
            <!-- Section des sorts -->
            <div class="tab-content active" id="spells-tab">
                <div class="spells-section">
                    <div class="spells-header">
                        <h3>Sorts disponibles pour <span id="classNameForSpells">votre classe</span></h3>
                        <div class="spells-filters">
                            <select id="spellLevelFilter">
                                <option value="">Tous les niveaux</option>
                                <option value="0">Tours de magie</option>
                                <option value="1">Niveau 1</option>
                                <option value="2">Niveau 2</option>
                                <option value="3">Niveau 3</option>
                                <option value="4">Niveau 4</option>
                                <option value="5">Niveau 5</option>
                                <option value="6">Niveau 6</option>
                                <option value="7">Niveau 7</option>
                                <option value="8">Niveau 8</option>
                                <option value="9">Niveau 9</option>
                            </select>
                            <select id="spellSchoolFilter">
                                <option value="">Toutes les √©coles</option>
                                <option value="Abjuration">Abjuration</option>
                                <option value="Conjuration">Conjuration</option>
                                <option value="Divination">Divination</option>
                                <option value="Enchantement">Enchantement</option>
                                <option value="√âvocation">√âvocation</option>
                                <option value="Illusion">Illusion</option>
                                <option value="N√©cromancie">N√©cromancie</option>
                                <option value="Transmutation">Transmutation</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="spellsList" class="spells-grid">
                        <!-- Les sorts seront charg√©s ici dynamiquement -->
                    </div>
                </div>
            </div>
            
            <!-- Section des aptitudes de combat -->
            <div class="tab-content" id="combat-abilities-tab">
                <div class="combat-abilities-section">
                    <h3>Aptitudes de combat par niveau</h3>
                    <div id="combatAbilitiesList" class="combat-abilities-list">
                        <!-- Les aptitudes seront charg√©es ici dynamiquement -->
                    </div>
                </div>
            </div>
            
            <!-- Section des traits raciaux -->
            <div class="tab-content" id="racial-traits-tab">
                <div class="racial-traits-section">
                    <h3>Traits raciaux pertinents</h3>
                    <div id="racialTraitsList" class="racial-traits-list">
                        <!-- Les traits seront charg√©s ici dynamiquement -->
                    </div>
                </div>
            </div>
            
            <!-- R√©sum√© des s√©lections -->
            <div class="spells-combat-summary">
                <h4>üìã S√©lections effectu√©es</h4>
                <div class="summary-tabs">
                    <div class="summary-section">
                        <h5>‚ú® Sorts s√©lectionn√©s</h5>
                        <div id="selectedSpellsList" class="selected-items">
                            <p class="empty-state">Aucun sort s√©lectionn√©</p>
                        </div>
                    </div>
                    <div class="summary-section">
                        <h5>‚öîÔ∏è Aptitudes importantes</h5>
                        <div id="selectedAbilitiesList" class="selected-items">
                            <p class="empty-state">Informations charg√©es automatiquement</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="navigation-buttons">
                <button type="button" class="nav-button prev" onclick="prevStep()">Pr√©c√©dent</button>
                <button type="button" class="nav-button next" onclick="nextStep()">Suivant</button>
            </div>
        </div>

        <!-- √âtape 5: √âquipement -->
        <div class="step-content" data-step="5">
            <h2>‚öîÔ∏è √âquipement du Personnage</h2>
            
            <div class="equipment-container">
                <!-- Contr√¥les d'√©quipement -->
                <div class="equipment-controls">
                    <div class="equipment-control-group">
                        <label for="maxValue">üí∞ Valeur maximale (po)</label>
                        <input type="number" id="maxValue" placeholder="Ex: 1000" min="0" step="1">
                    </div>
                    <div class="equipment-control-group">
                        <label for="maxWeight">‚öñÔ∏è Poids maximum (kg)</label>
                        <input type="number" id="maxWeight" placeholder="Ex: 50" min="0" step="0.1">
                    </div>
                </div>

                <!-- Zone de texte libre pour √©quipement personnalis√© -->
                <div class="equipment-section equipment-custom">
                    <h3>üìù √âquipement personnalis√©</h3>
                    <textarea id="customEquipment" name="custom_equipment" placeholder="D√©crivez l'√©quipement sp√©cial de votre personnage..." rows="3"></textarea>
                </div>

                <!-- S√©lection d'armure -->
                <div class="equipment-section">
                    <h3>üõ°Ô∏è Armure</h3>
                    <div class="equipment-row">
                        <select id="armorSelect" name="armor">
                            <option value="">Choisir une armure...</option>
                        </select>
                        <span id="armorProficiency" class="proficiency-indicator"></span>
                    </div>
                </div>

                <!-- S√©lection de bouclier -->
                <div class="equipment-section">
                    <h3>üõ°Ô∏è Bouclier</h3>
                    <div class="equipment-row">
                        <select id="shieldSelect" name="shield">
                            <option value="">Pas de bouclier</option>
                            <option value="Bouclier">Bouclier (+2 CA)</option>
                        </select>
                        <span id="shieldProficiency" class="proficiency-indicator"></span>
                    </div>
                </div>

                <!-- Arme principale -->
                <div class="equipment-section">
                    <h3>‚öîÔ∏è Arme principale</h3>
                    <div class="equipment-row">
                        <select id="mainWeaponSelect" name="main_weapon">
                            <option value="">Choisir une arme...</option>
                        </select>
                        <span id="mainWeaponProficiency" class="proficiency-indicator"></span>
                        <span id="mainWeaponRestriction" class="weapon-restriction"></span>
                    </div>
                </div>

                <!-- Arme secondaire -->
                <div class="equipment-section">
                    <h3>‚öîÔ∏è Arme secondaire</h3>
                    <div class="equipment-row">
                        <select id="secondaryWeaponSelect" name="secondary_weapon">
                            <option value="">Pas d'arme secondaire</option>
                        </select>
                        <span id="secondaryWeaponProficiency" class="proficiency-indicator"></span>
                        <span id="secondaryWeaponRestriction" class="weapon-restriction"></span>
                    </div>
                </div>

                <!-- Arme de secours -->
                <div class="equipment-section">
                    <h3>üèπ Arme de secours</h3>
                    <div class="equipment-row">
                        <select id="backupWeaponSelect" name="backup_weapon">
                            <option value="">Pas d'arme de secours</option>
                        </select>
                        <span id="backupWeaponProficiency" class="proficiency-indicator"></span>
                    </div>
                </div>

                <!-- Alertes d'√©quipement -->
                <div id="equipmentAlerts" class="equipment-section equipment-custom">
                    <div id="twoHandedAlert" class="equipment-alert error hidden">
                        ‚ö†Ô∏è Impossible d'utiliser une arme √† deux mains avec un bouclier
                    </div>
                    <div id="weightAlert" class="equipment-alert warning hidden">
                        ‚öñÔ∏è Poids de l'√©quipement d√©pass√©
                    </div>
                    <div id="valueAlert" class="equipment-alert warning hidden">
                        üí∞ Valeur de l'√©quipement d√©pass√©e
                    </div>
                </div>

                <!-- Indicateurs de limites -->
                <div class="equipment-limits equipment-custom">
                    <div class="limit-indicator">
                        <span class="limit-label">Valeur totale</span>
                        <span id="totalValue" class="limit-value ok">0 po</span>
                    </div>
                    <div class="limit-indicator">
                        <span class="limit-label">Poids total</span>
                        <span id="totalWeight" class="limit-value ok">0 kg</span>
                    </div>
                    <div class="limit-indicator">
                        <span class="limit-label">Objets s√©lectionn√©s</span>
                        <span id="totalItems" class="limit-value ok">0</span>
                    </div>
                </div>

                <!-- Inventaire d'objets -->
                <div class="equipment-section equipment-inventory">
                    <h3>üéí Inventaire</h3>
                    <div class="inventory-grid">
                        <!-- Les objets seront charg√©s dynamiquement par cat√©gorie -->
                    </div>
                </div>
            </div>

            <div class="navigation-buttons">
                <button type="button" class="nav-button prev" onclick="prevStep()">Pr√©c√©dent</button>
                <button type="button" class="nav-button next" onclick="nextStep()">Suivant</button>
            </div>
        </div>

        <!-- √âtape 6: Finalisation du personnage -->
        <div class="step-content" data-step="6">
            <h2>üë§ Finalisation du personnage</h2>
            
            <div class="finalization-container">
                <!-- Informations de base -->
                <div class="finalization-section">
                    <h3>üìã Informations personnelles</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="characterSex">Sexe</label>
                            <select id="characterSex" name="character_sex">
                                <option value="">Choisir...</option>
                                <option value="Homme">Homme</option>
                                <option value="Femme">Femme</option>
                                <option value="Non-binaire">Non-binaire</option>
                                <option value="Autre">Autre</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="characterAlignment">Alignement</label>
                            <select id="characterAlignment" name="character_alignment">
                                <option value="">Choisir...</option>
                                <option value="Loyal Bon">Loyal Bon</option>
                                <option value="Neutre Bon">Neutre Bon</option>
                                <option value="Chaotique Bon">Chaotique Bon</option>
                                <option value="Loyal Neutre">Loyal Neutre</option>
                                <option value="Neutre">Neutre</option>
                                <option value="Chaotique Neutre">Chaotique Neutre</option>
                                <option value="Loyal Mauvais">Loyal Mauvais</option>
                                <option value="Neutre Mauvais">Neutre Mauvais</option>
                                <option value="Chaotique Mauvais">Chaotique Mauvais</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="characterAge">√Çge r√©el</label>
                            <input type="number" id="characterAge" name="character_age" min="1" max="10000" placeholder="Ex: 25">
                        </div>
                    </div>
                </div>

                <!-- Physique -->
                <div class="finalization-section">
                    <h3>üìè Apparence physique</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="characterHeight">Taille</label>
                            <input type="text" id="characterHeight" name="character_height" placeholder="Ex: 1,75 m">
                        </div>
                        
                        <div class="form-group">
                            <label for="characterWeight">Poids</label>
                            <input type="text" id="characterWeight" name="character_weight" placeholder="Ex: 80 kg">
                        </div>
                        
                        <div class="form-group">
                            <label for="characterImageUrl">Lien vers une image (optionnel)</label>
                            <input type="url" id="characterImageUrl" name="character_image_url" placeholder="https://exemple.com/image.jpg">
                        </div>
                    </div>
                </div>

                <!-- Apparence d√©taill√©e -->
                <div class="finalization-section">
                    <h3>üëÅÔ∏è D√©tails d'apparence</h3>
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="characterEyes">Yeux</label>
                            <input type="text" id="characterEyes" name="character_eyes" placeholder="Ex: Bleus, verts, noisette...">
                        </div>
                        
                        <div class="form-group">
                            <label for="characterSkin">Peau</label>
                            <input type="text" id="characterSkin" name="character_skin" placeholder="Ex: Claire, mate, bronz√©e...">
                        </div>
                        
                        <div class="form-group">
                            <label for="characterHair">Cheveux</label>
                            <input type="text" id="characterHair" name="character_hair" placeholder="Ex: Bruns, blonds, roux...">
                        </div>
                    </div>
                </div>

                <!-- Descriptions -->
                <div class="finalization-section full-width">
                    <h3>‚ú® Apparence du personnage</h3>
                    <div class="form-group">
                        <label for="characterAppearance">Description physique d√©taill√©e</label>
                        <textarea id="characterAppearance" name="character_appearance" rows="4" 
                                placeholder="D√©crivez l'apparence g√©n√©rale de votre personnage, ses v√™tements, ses cicatrices, ses tatouages, etc."></textarea>
                    </div>
                </div>

                <div class="finalization-section full-width">
                    <h3>üìñ Histoire du personnage</h3>
                    <div class="form-group">
                        <label for="characterHistory">Histoire et background</label>
                        <textarea id="characterHistory" name="character_history" rows="6" 
                                placeholder="Racontez l'histoire de votre personnage, son pass√©, ses motivations, ses objectifs, etc."></textarea>
                    </div>
                </div>

                <!-- Aper√ßu de l'image -->
                <div class="finalization-section full-width" id="imagePreviewSection" style="display: none;">
                    <h3>üñºÔ∏è Aper√ßu de l'image</h3>
                    <div class="image-preview-container">
                        <img id="characterImagePreview" src="" alt="Aper√ßu du personnage" style="max-width: 300px; max-height: 400px; border-radius: 8px;">
                        <button type="button" class="remove-image-btn" onclick="removeImagePreview()">Supprimer l'image</button>
                    </div>
                </div>
            </div>

            <div class="navigation-buttons">
                <button type="button" class="nav-button prev" onclick="prevStep()">Pr√©c√©dent</button>
                <button type="submit" class="nav-button create">Cr√©er le personnage</button>
            </div>
        </div>

    </form>
    </div>

    <!-- R√©sum√© du personnage -->
    <div class="character-summary">
        <h3>üìã Fiche de votre personnage</h3>
        
        <!-- Informations de base -->
        <div class="summary-section">
            <h4>üè∑Ô∏è Identit√©</h4>
            <div class="summary-grid">
                <div class="summary-item">
                    <strong>Nom :</strong> <span id="summaryName">-</span>
                </div>
                <div class="summary-item">
                    <strong>Classe :</strong> <span id="summaryClass">-</span>
                </div>
                <div class="summary-item">
                    <strong>Race :</strong> <span id="summaryRace">-</span>
                </div>
                <div class="summary-item">
                    <strong>Historique :</strong> <span id="summaryBackground">-</span>
                </div>
            </div>
        </div>

        <!-- Caract√©ristiques -->
        <div class="summary-section">
            <h4>üí™ Caract√©ristiques</h4>
            <div class="summary-abilities">
                <div class="ability-summary" id="summary-force">
                    <span class="ability-name">FOR</span>
                    <span class="ability-modifier">+0</span>
                    <span class="ability-value">(10)</span>
                </div>
                <div class="ability-summary" id="summary-dexterite">
                    <span class="ability-name">DEX</span>
                    <span class="ability-modifier">+0</span>
                    <span class="ability-value">(10)</span>
                </div>
                <div class="ability-summary" id="summary-constitution">
                    <span class="ability-name">CON</span>
                    <span class="ability-modifier">+0</span>
                    <span class="ability-value">(10)</span>
                </div>
                <div class="ability-summary" id="summary-intelligence">
                    <span class="ability-name">INT</span>
                    <span class="ability-modifier">+0</span>
                    <span class="ability-value">(10)</span>
                </div>
                <div class="ability-summary" id="summary-sagesse">
                    <span class="ability-name">SAG</span>
                    <span class="ability-modifier">+0</span>
                    <span class="ability-value">(10)</span>
                </div>
                <div class="ability-summary" id="summary-charisme">
                    <span class="ability-name">CHA</span>
                    <span class="ability-modifier">+0</span>
                    <span class="ability-value">(10)</span>
                </div>
            </div>
        </div>

        <!-- Comp√©tences -->
        <div class="summary-section">
            <h4>üéØ Comp√©tences ma√Ætris√©es</h4>
            <div class="summary-skills">
                <div class="skills-category">
                    <span class="skills-label">Classe :</span>
                    <span id="summaryClassSkills">-</span>
                </div>
                <div class="skills-category">
                    <span class="skills-label">Historique :</span>
                    <span id="summaryBackgroundSkills">-</span>
                </div>
            </div>
        </div>

        <!-- Sorts et progression -->
        <div class="summary-section" id="summaryProgression" style="display: none;">
            <h4>‚ú® Progression magique</h4>
            <div class="progression-summary">
                <div class="progression-item">
                    <strong>Sorts s√©lectionn√©s :</strong> <span id="summarySpells">-</span>
                </div>
                <div class="progression-item" id="summarySubclassItem" style="display: none;">
                    <strong>Sp√©cialisation :</strong> <span id="summarySubclass">-</span>
                </div>
                <div class="progression-item" id="summaryMulticlassItem" style="display: none;">
                    <strong>Multiclassing :</strong> <span id="summaryMulticlass">-</span>
                </div>
            </div>
        </div>

        <!-- Historique d√©taill√© -->
        <div class="summary-section" id="summaryBackgroundDetails" style="display: none;">
            <h4>üìñ Votre historique</h4>
            <div class="background-summary">
                <div class="background-ability">
                    <strong>Aptitude :</strong> <span id="summaryBackgroundAbility">-</span>
                </div>
                <div class="background-equipment">
                    <strong>√âquipement :</strong> <span id="summaryBackgroundEquipment">-</span>
                </div>
                <div class="background-tools">
                    <strong>Outils :</strong> <span id="summaryBackgroundTools">-</span>
                </div>
                <div class="background-languages">
                    <strong>Langues :</strong> <span id="summaryBackgroundLanguages">-</span>
                </div>
            </div>
        </div>

        <!-- Personnalit√© -->
        <div class="summary-section" id="summaryPersonalitySection" style="display: none;">
            <h4>üé≠ Personnalit√©</h4>
            <div class="personality-summary">
                <div class="personality-item">
                    <strong>Trait :</strong> <span id="summaryPersonalityTrait">-</span>
                </div>
                <div class="personality-item">
                    <strong>Id√©al :</strong> <span id="summaryPersonalityIdeal">-</span>
                </div>
                <div class="personality-item">
                    <strong>Lien :</strong> <span id="summaryPersonalityBond">-</span>
                </div>
                <div class="personality-item">
                    <strong>D√©faut :</strong> <span id="summaryPersonalityFlaw">-</span>
                </div>
            </div>
        </div>

        <!-- Bonus raciaux -->
        <div class="summary-section" id="summaryRacialBonuses" style="display: none;">
            <h4>üß¨ Avantages raciaux</h4>
            <div class="racial-bonuses-summary">
                <div class="racial-abilities">
                    <strong>Bonus de caract√©ristiques :</strong> <span id="summaryRacialAbilities">-</span>
                </div>
            </div>
        </div>

        <!-- Choix effectu√©s -->
        <div class="summary-section" id="summaryChoices" style="display: none;">
            <h4>‚öôÔ∏è Choix personnalis√©s</h4>
            <div class="choices-summary">
                <div id="summaryRacialChoices" class="choice-item" style="display: none;">
                    <strong>Choix raciaux :</strong> <span class="choice-value"></span>
                </div>
                <div id="summaryBackgroundChoices" class="choice-item" style="display: none;">
                    <strong>Choix d'historique :</strong> <span class="choice-value"></span>
                </div>
                <div id="summarySkillChoices" class="choice-item" style="display: none;">
                    <strong>Choix de comp√©tences :</strong> <span class="choice-value"></span>
                </div>
            </div>
        </div>

        <!-- Statistiques de combat -->
        <div class="summary-section" id="summaryCombatStats">
            <h4>‚öîÔ∏è Statistiques de combat</h4>
            <div class="combat-stats-grid">
                <div class="combat-stat">
                    <strong>Points de vie :</strong> <span id="summaryHitPoints">-</span>
                </div>
                <div class="combat-stat">
                    <strong>Classe d'armure :</strong> <span id="summaryArmorClass">-</span>
                </div>
                <div class="combat-stat">
                    <strong>Bonus de ma√Ætrise :</strong> <span id="summaryProficiencyBonus">+2</span>
                </div>
                <div class="combat-stat">
                    <strong>Initiative :</strong> <span id="summaryInitiative">-</span>
                </div>
                <div class="combat-stat">
                    <strong>Vitesse :</strong> <span id="summarySpeed">9 m</span>
                </div>
            </div>
        </div>

        <!-- √âquipement -->
        <div class="summary-section" id="summaryEquipment">
            <h4>üéí √âquipement</h4>
            <div class="equipment-summary">
                <div class="equipment-category" id="summaryWeapons">
                    <strong>Armes :</strong>
                    <div class="equipment-list">
                        <span id="summaryWeaponsList">Aucune arme s√©lectionn√©e</span>
                    </div>
                </div>
                <div class="equipment-category" id="summaryArmor">
                    <strong>Protection :</strong>
                    <div class="equipment-list">
                        <span id="summaryArmorList">Aucune armure s√©lectionn√©e</span>
                    </div>
                </div>
                <div class="equipment-category" id="summaryInventory">
                    <strong>Inventaire :</strong>
                    <div class="equipment-list">
                        <span id="summaryInventoryList">Aucun objet s√©lectionn√©</span>
                    </div>
                </div>
                <div class="equipment-totals">
                    <div class="equipment-total">
                        <strong>Valeur totale :</strong> <span id="summaryTotalValue">0 po</span>
                    </div>
                    <div class="equipment-total">
                        <strong>Poids total :</strong> <span id="summaryTotalWeight">0 kg</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- D√©tails de finalisation -->
        <div class="summary-section" id="summaryFinalization" style="display: none;">
            <h4>üë§ D√©tails du personnage</h4>
            <div class="finalization-summary">
                <div class="finalization-grid">
                    <div class="finalization-item">
                        <strong>Sexe :</strong> <span id="summaryGender">-</span>
                    </div>
                    <div class="finalization-item">
                        <strong>Alignement :</strong> <span id="summaryAlignment">-</span>
                    </div>
                    <div class="finalization-item">
                        <strong>√Çge :</strong> <span id="summaryAge">-</span>
                    </div>
                    <div class="finalization-item">
                        <strong>Taille :</strong> <span id="summaryHeight">-</span>
                    </div>
                    <div class="finalization-item">
                        <strong>Poids :</strong> <span id="summaryWeight">-</span>
                    </div>
                </div>
                <div class="appearance-details">
                    <div class="appearance-item">
                        <strong>Yeux :</strong> <span id="summaryEyes">-</span>
                    </div>
                    <div class="appearance-item">
                        <strong>Peau :</strong> <span id="summarySkin">-</span>
                    </div>
                    <div class="appearance-item">
                        <strong>Cheveux :</strong> <span id="summaryHair">-</span>
                    </div>
                </div>
                <div class="character-image" id="summaryCharacterImage" style="display: none;">
                    <strong>Image du personnage :</strong>
                    <img id="summaryImagePreview" src="" alt="Aper√ßu du personnage" style="max-width: 200px; max-height: 200px; border-radius: 8px; margin-top: 0.5rem;">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de r√©sum√© final -->
<div id="finalSummaryModal" class="modal-overlay" style="display: none;">
    <div class="final-summary-modal">
        <div class="modal-header">
            <h2>üéâ Votre personnage est pr√™t !</h2>
            <button type="button" class="close-modal" onclick="closeFinalSummary()">&times;</button>
        </div>
        
        <div class="modal-body">
            <div class="final-summary-content">
                <!-- Carte du personnage -->
                <div class="character-card-final">
                    <div class="character-header">
                        <div class="character-portrait" id="finalCharacterPortrait">
                            <img id="finalCharacterImage" src="" alt="Portrait" style="display: none;">
                            <div class="default-portrait">üë§</div>
                        </div>
                        <div class="character-title">
                            <h3 id="finalCharacterName">Nom du personnage</h3>
                            <p id="finalCharacterClass">Classe et niveau</p>
                            <p id="finalCharacterRace">Race</p>
                        </div>
                    </div>
                    
                    <div class="character-details-grid">
                        <div class="detail-section">
                            <h4>üìä Caract√©ristiques</h4>
                            <div class="abilities-final" id="finalAbilities"></div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>‚öîÔ∏è Combat</h4>
                            <div class="combat-final">
                                <div class="combat-item">PV: <span id="finalHitPoints">-</span></div>
                                <div class="combat-item">CA: <span id="finalArmorClass">-</span></div>
                                <div class="combat-item">Initiative: <span id="finalInitiative">-</span></div>
                                <div class="combat-item">Vitesse: <span id="finalSpeed">9 m</span></div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>üéØ Comp√©tences</h4>
                            <div class="skills-final" id="finalSkills"></div>
                        </div>
                        
                        <div class="detail-section">
                            <h4>üéí √âquipement</h4>
                            <div class="equipment-final">
                                <div class="equipment-weapons" id="finalWeapons"></div>
                                <div class="equipment-armor" id="finalArmor"></div>
                                <div class="equipment-totals">
                                    <small>Valeur: <span id="finalTotalValue">0 po</span> | Poids: <span id="finalTotalWeight">0 kg</span></small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sections d√©taill√©es -->
                <div class="detailed-sections">
                    <div class="detail-accordion">
                        <div class="accordion-item">
                            <button class="accordion-header" onclick="toggleAccordion('personality-details')">
                                üé≠ Personnalit√© et historique
                            </button>
                            <div class="accordion-content" id="personality-details">
                                <div id="finalPersonalityDetails"></div>
                            </div>
                        </div>
                        
                        <div class="accordion-item" id="spells-accordion" style="display: none;">
                            <button class="accordion-header" onclick="toggleAccordion('spells-details')">
                                ‚ú® Sorts et capacit√©s magiques
                            </button>
                            <div class="accordion-content" id="spells-details">
                                <div id="finalSpellsDetails"></div>
                            </div>
                        </div>
                        
                        <div class="accordion-item">
                            <button class="accordion-header" onclick="toggleAccordion('equipment-details')">
                                üì¶ Inventaire d√©taill√©
                            </button>
                            <div class="accordion-content" id="equipment-details">
                                <div id="finalEquipmentDetails"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeFinalSummary()">Modifier</button>
            <button type="button" class="btn btn-primary" onclick="confirmCharacterCreation()">Cr√©er le personnage</button>
        </div>
    </div>
</div>

<script>
    let currentStep = 1;
    let selectedClass = null;
    let selectedRace = null;
    let selectedBackground = null;
    let selectedVariant = null;
    let backgroundsData = {};
    let selectedPersonality = {
        trait: null,
        ideal: null,
        bond: null,
        flaw: null
    };
    let totalPoints = 27;
    let usedPoints = 0;
    let selectedClassSkills = [];
    let selectedBackgroundSkills = [];
    let selectedInventory = [];
    let selectedMulticlass = null;
    let selectedSubclass = null;  
    let selectedSpells = [];
    let equipmentData = null;
    
    // Co√ªts en points pour chaque valeur de caract√©ristique
    const pointCosts = {
        8: 0, 9: 1, 10: 2, 11: 3, 12: 4, 13: 5, 14: 7, 15: 9
    };

    // Comp√©tences disponibles par classe
    const classSkills = {
        'barbare': {
            available: ['Athl√©tisme', 'Dressage', 'Intimidation', 'Nature', 'Perception', 'Survie'],
            count: 2
        },
        'barde': {
            available: ['Tromperie', 'Histoire', 'Investigation', 'Persuasion', 'Repr√©sentation', 'Discr√©tion'],
            count: 3
        },
        'clerc': {
            available: ['Histoire', 'Perspicacit√©', 'M√©decine', 'Persuasion', 'Religion'],
            count: 2
        },
        'druide': {
            available: ['Arcanes', 'Dressage', 'Perspicacit√©', 'M√©decine', 'Nature', 'Perception', 'Religion', 'Survie'],
            count: 2
        },
        'ensorceleur': {
            available: ['Arcanes', 'Tromperie', 'Perspicacit√©', 'Intimidation', 'Persuasion', 'Religion'],
            count: 2
        },
        'guerrier': {
            available: ['Acrobaties', 'Dressage', 'Athl√©tisme', 'Histoire', 'Perspicacit√©', 'Intimidation', 'Perception', 'Survie'],
            count: 2
        },
        'magicien': {
            available: ['Arcanes', 'Histoire', 'Perspicacit√©', 'Investigation', 'M√©decine', 'Religion'],
            count: 2
        },
        'moine': {
            available: ['Acrobaties', 'Athl√©tisme', 'Histoire', 'Perspicacit√©', 'Religion', 'Discr√©tion'],
            count: 2
        },
        'paladin': {
            available: ['Athl√©tisme', 'Perspicacit√©', 'Intimidation', 'M√©decine', 'Persuasion', 'Religion'],
            count: 2
        },
        'rodeur': {
            available: ['Dressage', 'Athl√©tisme', 'Perspicacit√©', 'Investigation', 'Nature', 'Perception', 'Discr√©tion', 'Survie'],
            count: 3
        },
        'roublard': {
            available: ['Acrobaties', 'Athl√©tisme', 'Tromperie', 'Perspicacit√©', 'Intimidation', 'Investigation', 'Perception', 'Repr√©sentation', 'Persuasion', 'Escamotage', 'Discr√©tion'],
            count: 4
        },
        'sorcier': {
            available: ['Arcanes', 'Tromperie', 'Histoire', 'Intimidation', 'Investigation', 'Nature', 'Religion'],
            count: 2
        }
    };

    // Bonus de caract√©ristiques par race
    const racialBonuses = {
        'humain': { force: 1, dexterite: 1, constitution: 1, intelligence: 1, sagesse: 1, charisme: 1 },
        'elfe': { dexterite: 2 },
        'nain': { constitution: 2 },
        'halfelin': { dexterite: 2 },
        'gnome': { intelligence: 2 },
        'demi-elfe': { charisme: 2, choice: 2 }, // +2 Charisme, +1 √† deux autres au choix
        'demi-orc': { force: 2, constitution: 1 },
        'tieffelin': { charisme: 2, intelligence: 1 },
        'aasimar': { charisme: 2 },
        'sangdragon': { force: 2, charisme: 1 },
        'felys': { dexterite: 2, charisme: 1 }
    };

    // Chargement des historiques au d√©marrage
    document.addEventListener('DOMContentLoaded', function() {
        loadBackgrounds();
    });

    // Formater l'affichage des comp√©tences pour les cartes (fixes + choix)
    function formatSkillsDisplay(background) {
        let skillsText = [];
        
        // Ajouter les comp√©tences fixes
        if (background.skills && background.skills.length > 0) {
            skillsText = [...background.skills];
        }
        
        // Ajouter les choix de comp√©tences
        if (background.skill_choices && background.skill_choices.length > 0) {
            background.skill_choices.forEach(choice => {
                skillsText.push(choice.description);
            });
        }
        
        return skillsText.join(', ') || 'Aucune';
    }

    // Charger les historiques depuis l'API
    async function loadBackgrounds() {
        try {
            const response = await fetch('/api/backgrounds');
            backgroundsData = await response.json();
            displayBackgrounds();
        } catch (error) {
            console.error('Erreur lors du chargement des historiques:', error);
            document.getElementById('backgrounds-loading').innerHTML = 
                '<p style="color: red;">Erreur lors du chargement des historiques</p>';
        }
    }

    // Afficher les historiques
    function displayBackgrounds() {
        const grid = document.getElementById('backgrounds-grid');
        const container = document.getElementById('backgrounds-container');
        const loading = document.getElementById('backgrounds-loading');
        
        grid.innerHTML = '';
        
        Object.values(backgroundsData).forEach(background => {
            const card = document.createElement('div');
            card.className = 'background-card';
            card.dataset.background = background.id;
            
            card.innerHTML = `
                <h4>${background.title}</h4>
                <div class="background-skills">${formatSkillsDisplay(background)}</div>
                ${Object.keys(background.variants || {}).length > 0 ? 
                    `<div class="variant-count">${Object.keys(background.variants).length} variante(s)</div>` : ''}
            `;
            
            card.addEventListener('click', () => selectBackground(background.id));
            grid.appendChild(card);
        });
        
        loading.style.display = 'none';
        container.style.display = 'block';
    }

    // S√©lectionner un historique
    function selectBackground(backgroundId) {
        // D√©s√©lectionner l'ancien
        document.querySelectorAll('.background-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // S√©lectionner le nouveau
        const selectedCard = document.querySelector(`[data-background="${backgroundId}"]`);
        selectedCard.classList.add('selected');
        
        selectedBackground = backgroundId;
        selectedVariant = null; // Reset variant
        backgroundChoices = {}; // Reset des choix d'historique
        selectedPersonality = { trait: null, ideal: null, bond: null, flaw: null }; // Reset personnalit√©
        selectedClassSkills = []; // Reset des comp√©tences de classe
        document.getElementById('selectedBackground').value = backgroundId;
        document.getElementById('selectedVariant').value = '';
        document.getElementById('backgroundChoicesInput').value = '';
        document.getElementById('classSkillsInput').value = '';
        
        // Reset des champs de personnalit√©
        ['trait', 'ideal', 'bond', 'flaw'].forEach(type => {
            const input = document.getElementById(`${type}-input`);
            if (input) input.value = '';
        });
        
        // Afficher les variantes s'il y en a
        const background = backgroundsData[backgroundId];
        displayVariants(background);
        
        // Afficher les d√©tails de l'historique
        displayBackgroundDetails(background);
        
        // Afficher les traits de personnalit√©
        displayPersonalityTraits(background);
        
        // Afficher la section des comp√©tences de classe
        displayClassSkillsSection(background);
        
        // Mettre √† jour le r√©sum√©
        updateCharacterSummary();
    }

    // Afficher le bouton des variantes (sans les afficher automatiquement)
    function displayVariants(background) {
        const showButton = document.getElementById('show-variants-button');
        const variantSection = document.getElementById('variant-selection');
        const variantsGrid = document.getElementById('variants-grid');
        
        if (background.variants && Object.keys(background.variants).length > 0) {
            // Pr√©parer les variantes mais ne pas les afficher
            variantsGrid.innerHTML = '';
            
            Object.entries(background.variants).forEach(([variantId, variant]) => {
                const card = document.createElement('div');
                card.className = 'variant-card';
                card.dataset.variant = variantId;
                
                card.innerHTML = `
                    <h5>${variant.name}</h5>
                    <div class="variant-skills">${formatSkillsDisplay(variant)}</div>
                `;
                
                card.addEventListener('click', () => selectVariant(variantId, variant));
                variantsGrid.appendChild(card);
            });
            
            // Afficher le bouton pour voir les variantes
            showButton.style.display = 'block';
            variantSection.style.display = 'none';
        } else {
            showButton.style.display = 'none';
            variantSection.style.display = 'none';
        }
    }

    // Fonction pour basculer l'affichage des variantes
    function toggleVariants() {
        const variantSection = document.getElementById('variant-selection');
        const showButton = document.getElementById('show-variants-button');
        
        if (variantSection.style.display === 'none') {
            variantSection.style.display = 'block';
            showButton.style.display = 'none';
        }
    }

    // Fonction pour revenir √† l'historique de base
    function selectBaseBackground() {
        const variantSection = document.getElementById('variant-selection');
        const showButton = document.getElementById('show-variants-button');
        
        // D√©s√©lectionner toutes les variantes
        document.querySelectorAll('.variant-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        selectedVariant = null;
        document.getElementById('selectedVariant').value = '';
        
        // Afficher les d√©tails de l'historique de base
        const background = backgroundsData[selectedBackground];
        if (background) {
            displayBackgroundDetails(background);
        }
        
        // Masquer les variantes et r√©afficher le bouton
        variantSection.style.display = 'none';
        showButton.style.display = 'block';
        
        updateCharacterSummary();
    }

    // S√©lectionner une variante
    function selectVariant(variantId, variant) {
        // D√©s√©lectionner l'ancienne variante
        document.querySelectorAll('.variant-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // S√©lectionner la nouvelle
        const selectedCard = document.querySelector(`[data-variant="${variantId}"]`);
        selectedCard.classList.add('selected');
        
        selectedVariant = variantId;
        document.getElementById('selectedVariant').value = variantId;
        
        // Mettre √† jour les d√©tails avec la variante
        displayVariantDetails(variant);
        
        // Mettre √† jour le r√©sum√©
        updateCharacterSummary();
    }

    // Afficher les d√©tails de l'historique de base
    function displayBackgroundDetails(background, variant = null) {
        const detailsSection = document.getElementById('background-details');
        const data = variant || background;
        
        // Afficher l'aptitude (variante en priorit√©, puis base)
        let abilityToShow = null;
        if (variant && variant.ability) {
            // La variante a sa propre aptitude
            abilityToShow = variant.ability;
        } else if (background && background.ability) {
            // Utiliser l'aptitude de base
            abilityToShow = background.ability;
        }
        
        if (abilityToShow) {
            const abilitySection = document.getElementById('background-ability-section');
            document.getElementById('ability-name').textContent = abilityToShow.name;
            document.getElementById('ability-description').textContent = abilityToShow.description;
            abilitySection.style.display = 'block';
        } else {
            document.getElementById('background-ability-section').style.display = 'none';
        }
        
        // Afficher les sections sp√©ciales (seulement pour l'historique de base)
        if (!variant && background && background.special_sections && background.special_sections.length > 0) {
            displaySpecialSections(background.special_sections);
        } else {
            document.getElementById('background-special-sections').innerHTML = '';
        }
        
        // Afficher les sections de choix (seulement pour l'historique de base)
        if (!variant && background && background.choice_sections && background.choice_sections.length > 0) {
            displayChoiceSections(background.choice_sections);
        } else {
            document.getElementById('background-choice-sections').innerHTML = '';
        }
        
        // Afficher les choix de comp√©tences d'historique
        displayBackgroundSkillChoices(data);
        
        document.getElementById('background-skills-display').innerHTML = 
            (data && data.skills && data.skills.length > 0) ? data.skills.join(', ') : 'Aucune';
        
        document.getElementById('background-tools-display').innerHTML = 
            (data && data.tools && data.tools.length > 0) ? data.tools.join(', ') : 'Aucun';
        
        document.getElementById('background-languages-display').innerHTML = 
            (data && data.languages && data.languages.length > 0) ? data.languages.join(', ') : 'Aucune';
        
        document.getElementById('background-equipment-display').innerHTML = 
            (data && data.equipment && data.equipment.length > 0) ? data.equipment.join(', ') : 'Aucun';
        
        detailsSection.style.display = 'block';
    }

    // Afficher les sections sp√©ciales
    function displaySpecialSections(sections) {
        const container = document.getElementById('background-special-sections');
        container.innerHTML = '';
        
        sections.forEach(section => {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'special-section';
            
            let sectionHtml = `
                <h5>${section.title}</h5>
                <div class="special-section-content">${section.content}</div>
            `;
            
            // Afficher les tables s'il y en a
            if (section.tables && section.tables.length > 0) {
                section.tables.forEach(table => {
                    sectionHtml += `
                        <div class="special-table">
                            ${table.rows.map(row => `
                                <div class="special-table-row">
                                    <div class="special-table-roll">${row.roll}</div>
                                    <div class="special-table-text">${row.text}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                });
            }
            
            sectionDiv.innerHTML = sectionHtml;
            container.appendChild(sectionDiv);
        });
    }

    // Afficher les sections de choix interactives
    function displayChoiceSections(choiceSections) {
        const container = document.getElementById('background-choice-sections');
        container.innerHTML = '';
        
        choiceSections.forEach(section => {
            const sectionDiv = document.createElement('div');
            sectionDiv.className = 'choice-section';
            
            let sectionHtml = `
                <h5>${section.title}</h5>
                <div class="choice-description">${section.description}</div>
                <div class="choice-options" data-section="${section.title}">
                    ${section.options.map(option => `
                        <div class="choice-option" data-choice="${option.text}" data-section="${section.title}">
                            <div class="choice-roll">${option.roll}</div>
                            <div class="choice-text">${option.text}</div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            sectionDiv.innerHTML = sectionHtml;
            container.appendChild(sectionDiv);
        });
        
        // Ajouter les event listeners pour les choix
        container.querySelectorAll('.choice-option').forEach(option => {
            option.addEventListener('click', () => selectBackgroundChoice(option));
        });
    }
    
    // Variables pour stocker les choix de l'historique
    let backgroundChoices = {};
    let backgroundSkillChoices = {};
    
    // S√©lectionner un choix d'historique
    function selectBackgroundChoice(optionElement) {
        const section = optionElement.dataset.section;
        const choice = optionElement.dataset.choice;
        
        // D√©s√©lectionner les autres options de la m√™me section
        const sectionContainer = optionElement.closest('.choice-options');
        sectionContainer.querySelectorAll('.choice-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // S√©lectionner la nouvelle option
        optionElement.classList.add('selected');
        
        // Stocker le choix
        backgroundChoices[section] = choice;
        
        // Mettre √† jour le champ cach√©
        document.getElementById('backgroundChoicesInput').value = JSON.stringify(backgroundChoices);
        
        console.log('Choix d\'historique s√©lectionn√©:', section, '=', choice);
    }

    // Afficher les choix de comp√©tences d'historique
    function displayBackgroundSkillChoices(data) {
        const skillChoicesSection = document.getElementById('background-skill-choices');
        const skillChoicesList = document.getElementById('background-skill-choices-list');
        
        if (!data || !data.skill_choices || data.skill_choices.length === 0) {
            skillChoicesSection.style.display = 'none';
            return;
        }
        
        skillChoicesList.innerHTML = '';
        
        data.skill_choices.forEach((choice, index) => {
            const choiceDiv = document.createElement('div');
            choiceDiv.className = 'skill-choice-item';
            
            choiceDiv.innerHTML = `
                <h5>Choisir une comp√©tence : ${choice.description}</h5>
                <div class="skill-choice-options" data-choice-index="${index}">
                    ${choice.options.map(option => `
                        <div class="skill-choice-option" data-skill="${option}" data-choice-index="${index}">
                            ${option}
                        </div>
                    `).join('')}
                </div>
            `;
            
            skillChoicesList.appendChild(choiceDiv);
        });
        
        // Ajouter les event listeners
        skillChoicesList.querySelectorAll('.skill-choice-option').forEach(option => {
            option.addEventListener('click', () => selectBackgroundSkillChoice(option));
        });
        
        skillChoicesSection.style.display = 'block';
    }
    
    // S√©lectionner un choix de comp√©tence d'historique
    function selectBackgroundSkillChoice(optionElement) {
        const choiceIndex = optionElement.dataset.choiceIndex;
        const skill = optionElement.dataset.skill;
        
        // D√©s√©lectionner les autres options du m√™me choix
        const choiceContainer = optionElement.closest('.skill-choice-options');
        choiceContainer.querySelectorAll('.skill-choice-option').forEach(opt => {
            opt.classList.remove('selected');
        });
        
        // S√©lectionner la nouvelle option
        optionElement.classList.add('selected');
        
        // Stocker le choix
        backgroundSkillChoices[choiceIndex] = skill;
        
        // Mettre √† jour le champ cach√©
        document.getElementById('backgroundSkillChoicesInput').value = JSON.stringify(backgroundSkillChoices);
        
        // Mettre √† jour l'affichage des comp√©tences de classe
        updateClassSkillsDisplay();
        
        console.log('Choix de comp√©tence d\'historique:', choiceIndex, '=', skill);
    }

    // Afficher les d√©tails de la variante
    function displayVariantDetails(variant) {
        displayBackgroundDetails(null, variant);
        
        // Les personnalit√©s viennent toujours de l'historique principal, pas de la variante
        if (selectedBackground && backgroundsData[selectedBackground]) {
            const baseBackground = backgroundsData[selectedBackground];
            displayPersonalityTraits(baseBackground);
            
            // Mettre √† jour les comp√©tences de classe en tenant compte des comp√©tences de la variante
            updateClassSkills();
        }
    }

    // Afficher les traits de personnalit√© avec champs de texte
    function displayPersonalityTraits(background) {
        const personalitySection = document.getElementById('personality-section');
        
        // Stocker les suggestions pour chaque cat√©gorie
        personalityData = {
            'trait': background.personality_traits || [],
            'ideal': background.ideals || [],
            'bond': background.bonds || [],
            'flaw': background.flaws || []
        };
        
        // Populate suggestions (hidden by default)
        populateSuggestions('trait', personalityData.trait);
        populateSuggestions('ideal', personalityData.ideal);
        populateSuggestions('bond', personalityData.bond);
        populateSuggestions('flaw', personalityData.flaw);
        
        personalitySection.style.display = 'block';
    }

    // Variable pour stocker les donn√©es de personnalit√©
    let personalityData = {};

    // Remplir les suggestions pour une cat√©gorie
    function populateSuggestions(type, traits) {
        const container = document.getElementById(`${type}-suggestions`);
        container.innerHTML = '';
        
        traits.forEach(trait => {
            const item = document.createElement('div');
            item.className = 'suggestion-item';
            
            // Extraire l'alignement pour les id√©aux
            const alignmentMatch = trait.text.match(/\(([^)]+)\)$/);
            const alignment = alignmentMatch ? alignmentMatch[1] : '';
            const text = trait.text.replace(/\s*\([^)]+\)$/, '');
            
            item.innerHTML = `
                <div class="suggestion-roll">D${trait.roll}</div>
                <div class="suggestion-text">
                    ${text}
                    ${alignment ? `<br><em style="color: var(--accent-color);">(${alignment})</em>` : ''}
                </div>
            `;
            
            item.addEventListener('click', () => selectSuggestion(type, trait.text));
            container.appendChild(item);
        });
    }

    // Basculer l'affichage des suggestions
    function toggleSuggestions(type) {
        const suggestionsContainer = document.getElementById(`${type}-suggestions`);
        const toggle = document.querySelector(`[onclick="toggleSuggestions('${type}')"]`);
        
        if (suggestionsContainer.style.display === 'none') {
            suggestionsContainer.style.display = 'block';
            toggle.querySelector('span').textContent = 'Masquer les suggestions';
        } else {
            suggestionsContainer.style.display = 'none';
            toggle.querySelector('span').textContent = 'Voir les suggestions';
        }
    }

    // S√©lectionner une suggestion
    function selectSuggestion(type, text) {
        const inputId = `${type}-input`;
        const input = document.getElementById(inputId);
        
        // Ins√©rer le texte dans le champ
        input.value = text;
        
        // D√©clencher l'√©v√©nement de changement pour la validation
        input.dispatchEvent(new Event('input'));
        
        // Fermer les suggestions
        document.getElementById(`${type}-suggestions`).style.display = 'none';
        document.querySelector(`[onclick="toggleSuggestions('${type}')"] span`).textContent = 'Voir les suggestions';
        
        // Mettre √† jour le stockage
        selectedPersonality[type] = text;
        
        console.log(`Suggestion s√©lectionn√©e pour ${type}:`, text);
    }

    // G√©rer les changements dans les champs de personnalit√©
    document.addEventListener('DOMContentLoaded', function() {
        ['trait', 'ideal', 'bond', 'flaw'].forEach(type => {
            const input = document.getElementById(`${type}-input`);
            if (input) {
                input.addEventListener('input', function() {
                    selectedPersonality[type] = this.value.trim();
                });
            }
        });
    });

    // Fonction pour mettre √† jour le r√©sum√© d√©taill√©
    function updateSummary() {
        updateBasicInfo();
        updateAbilitiesInSummary();
        updateSkillsInSummary();
        updateBackgroundInSummary();
        updatePersonalityInSummary();
        updateRacialBonusesInSummary();
        updateChoicesInSummary();
    }
    
    // Mise √† jour des informations de base
    function updateBasicInfo() {
        // Nom
        const nameInput = document.getElementById('characterName');
        const summaryName = document.getElementById('summaryName');
        if (summaryName) {
            summaryName.textContent = nameInput && nameInput.value.trim() ? nameInput.value : '-';
        }
        
        // Classe
        const summaryClass = document.getElementById('summaryClass');
        if (summaryClass) {
            if (selectedClass) {
                const classCard = document.querySelector(`[data-class="${selectedClass}"]`);
                if (classCard) {
                    const h3 = classCard.querySelector('h3');
                    summaryClass.textContent = h3 ? h3.textContent : selectedClass;
                } else {
                    summaryClass.textContent = selectedClass;
                }
            } else {
                summaryClass.textContent = '-';
            }
        }
        
        // Race
        const summaryRace = document.getElementById('summaryRace');
        if (summaryRace) {
            if (selectedRace) {
                const raceCard = document.querySelector(`[data-race="${selectedRace}"]`);
                if (raceCard) {
                    const h3 = raceCard.querySelector('h3');
                    summaryRace.textContent = h3 ? h3.textContent : selectedRace;
                } else {
                    summaryRace.textContent = selectedRace;
                }
            } else {
                summaryRace.textContent = '-';
            }
        }
        
        // Historique
        const summaryBackground = document.getElementById('summaryBackground');
        if (summaryBackground) {
            let backgroundText = '-';
            if (selectedBackground && backgroundsData && backgroundsData[selectedBackground]) {
                const background = backgroundsData[selectedBackground];
                backgroundText = background.title || selectedBackground;
                if (selectedVariant && background.variants && background.variants[selectedVariant]) {
                    backgroundText += ` (${background.variants[selectedVariant].name})`;
                }
            } else if (selectedBackground) {
                backgroundText = selectedBackground;
            }
            summaryBackground.textContent = backgroundText;
        }
    }
    
    // Mise √† jour des caract√©ristiques dans le r√©sum√©
    function updateAbilitiesInSummary() {
        ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse', 'charisme'].forEach(ability => {
            const input = document.getElementById(ability);
            const summaryElement = document.getElementById(`summary-${ability}`);
            
            if (input && summaryElement) {
                const baseScore = parseInt(input.value);
                const racialBonus = getRacialBonus(ability);
                const finalScore = baseScore + racialBonus;
                const modifier = Math.floor((finalScore - 10) / 2);
                const modifierText = modifier >= 0 ? `+${modifier}` : `${modifier}`;
                
                const valueElement = summaryElement.querySelector('.ability-value');
                const modifierElement = summaryElement.querySelector('.ability-modifier');
                
                if (modifierElement) {
                    modifierElement.textContent = modifierText;
                    if (racialBonus > 0) {
                        modifierElement.style.color = '#2ecc71';
                    } else {
                        modifierElement.style.color = 'var(--success-color)';
                    }
                }
                
                if (valueElement) {
                    valueElement.textContent = `(${finalScore})`;
                }
            }
        });
    }
    
    // Mise √† jour des comp√©tences dans le r√©sum√©
    function updateSkillsInSummary() {
        // Comp√©tences de classe
        const summaryClassSkills = document.getElementById('summaryClassSkills');
        if (summaryClassSkills) {
            if (selectedClassSkills.length > 0) {
                summaryClassSkills.textContent = selectedClassSkills.join(', ');
            } else {
                summaryClassSkills.textContent = 'Aucune s√©lectionn√©e';
            }
        }
        
        // Comp√©tences d'historique
        const summaryBackgroundSkills = document.getElementById('summaryBackgroundSkills');
        if (summaryBackgroundSkills) {
            const backgroundSkills = getAllBackgroundSkills();
            if (backgroundSkills.length > 0) {
                summaryBackgroundSkills.textContent = backgroundSkills.join(', ');
            } else {
                summaryBackgroundSkills.textContent = 'Aucune';
            }
        }
    }
    
    // Mise √† jour de l'historique d√©taill√© dans le r√©sum√©
    function updateBackgroundInSummary() {
        const detailsSection = document.getElementById('summaryBackgroundDetails');
        
        if (selectedBackground && backgroundsData[selectedBackground]) {
            const background = backgroundsData[selectedBackground];
            let data = background;
            
            // Si une variante est s√©lectionn√©e, utiliser ses donn√©es
            if (selectedVariant && background.variants && background.variants[selectedVariant]) {
                data = background.variants[selectedVariant];
                // H√©riter de l'aptitude de base si la variante n'en a pas
                if (!data.ability && background.ability) {
                    data.ability = background.ability;
                }
            }
            
            // Aptitude (titre seulement, pas la description compl√®te)
            const summaryAbility = document.getElementById('summaryBackgroundAbility');
            if (summaryAbility) {
                if (data.ability) {
                    summaryAbility.textContent = data.ability.name;
                    summaryAbility.title = data.ability.description; // Affiche la description au survol
                } else {
                    summaryAbility.textContent = 'Aucune aptitude d√©finie';
                    summaryAbility.title = '';
                }
            }
            
            // √âquipement
            const summaryEquipment = document.getElementById('summaryBackgroundEquipment');
            if (summaryEquipment) {
                summaryEquipment.textContent = data.equipment && data.equipment.length > 0 ? data.equipment.join(', ') : 'Aucun';
            }
            
            // Outils
            const summaryTools = document.getElementById('summaryBackgroundTools');
            if (summaryTools) {
                summaryTools.textContent = data.tools && data.tools.length > 0 ? data.tools.join(', ') : 'Aucun';
            }
            
            // Langues
            const summaryLanguages = document.getElementById('summaryBackgroundLanguages');
            if (summaryLanguages) {
                summaryLanguages.textContent = data.languages && data.languages.length > 0 ? data.languages.join(', ') : 'Aucune';
            }
            
            detailsSection.style.display = 'block';
        } else {
            detailsSection.style.display = 'none';
        }
    }
    
    // Mise √† jour de la personnalit√© dans le r√©sum√©
    function updatePersonalityInSummary() {
        const personalitySection = document.getElementById('summaryPersonalitySection');
        
        // V√©rifier si au moins un trait de personnalit√© est rempli
        const traitInput = document.getElementById('trait-input');
        const idealInput = document.getElementById('ideal-input');
        const bondInput = document.getElementById('bond-input');
        const flawInput = document.getElementById('flaw-input');
        
        const hasPersonality = (traitInput && traitInput.value.trim()) ||
                              (idealInput && idealInput.value.trim()) ||
                              (bondInput && bondInput.value.trim()) ||
                              (flawInput && flawInput.value.trim());
        
        if (hasPersonality) {
            // Trait
            const summaryTrait = document.getElementById('summaryPersonalityTrait');
            if (summaryTrait) {
                summaryTrait.textContent = traitInput && traitInput.value.trim() ? traitInput.value : '-';
            }
            
            // Id√©al
            const summaryIdeal = document.getElementById('summaryPersonalityIdeal');
            if (summaryIdeal) {
                summaryIdeal.textContent = idealInput && idealInput.value.trim() ? idealInput.value : '-';
            }
            
            // Lien
            const summaryBond = document.getElementById('summaryPersonalityBond');
            if (summaryBond) {
                summaryBond.textContent = bondInput && bondInput.value.trim() ? bondInput.value : '-';
            }
            
            // D√©faut
            const summaryFlaw = document.getElementById('summaryPersonalityFlaw');
            if (summaryFlaw) {
                summaryFlaw.textContent = flawInput && flawInput.value.trim() ? flawInput.value : '-';
            }
            
            personalitySection.style.display = 'block';
        } else {
            personalitySection.style.display = 'none';
        }
    }
    
    // Mise √† jour des bonus raciaux dans le r√©sum√©
    function updateRacialBonusesInSummary() {
        const racialSection = document.getElementById('summaryRacialBonuses');
        
        if (selectedRace && racialBonuses[selectedRace]) {
            const bonuses = racialBonuses[selectedRace];
            const summaryAbilities = document.getElementById('summaryRacialAbilities');
            
            let bonusText = [];
            
            // Bonus fixes
            Object.keys(bonuses).forEach(ability => {
                if (ability !== 'choice' && bonuses[ability] > 0) {
                    const abilityName = ability === 'dexterite' ? 'Dext√©rit√©' : 
                                       ability.charAt(0).toUpperCase() + ability.slice(1);
                    bonusText.push(`${abilityName} +${bonuses[ability]}`);
                }
            });
            
            // Choix raciaux
            if (Object.keys(racialChoices).length > 0) {
                Object.keys(racialChoices).forEach(ability => {
                    const abilityName = ability === 'dexterite' ? 'Dext√©rit√©' : 
                                       ability.charAt(0).toUpperCase() + ability.slice(1);
                    bonusText.push(`${abilityName} +${racialChoices[ability]} (choix)`);
                });
            }
            
            if (summaryAbilities) {
                summaryAbilities.textContent = bonusText.length > 0 ? bonusText.join(', ') : 'Aucun bonus';
            }
            
            racialSection.style.display = 'block';
        } else {
            racialSection.style.display = 'none';
        }
    }
    
    // Mise √† jour des choix dans le r√©sum√©
    function updateChoicesInSummary() {
        const choicesSection = document.getElementById('summaryChoices');
        let hasChoices = false;
        
        // Choix raciaux
        const racialChoicesDiv = document.getElementById('summaryRacialChoices');
        if (Object.keys(racialChoices).length > 0) {
            const choicesText = Object.keys(racialChoices).map(ability => {
                const abilityName = ability === 'dexterite' ? 'Dext√©rit√©' : 
                                   ability.charAt(0).toUpperCase() + ability.slice(1);
                return `${abilityName} +${racialChoices[ability]}`;
            }).join(', ');
            racialChoicesDiv.querySelector('.choice-value').textContent = choicesText;
            racialChoicesDiv.style.display = 'block';
            hasChoices = true;
        } else {
            racialChoicesDiv.style.display = 'none';
        }
        
        // Choix d'historique
        const backgroundChoicesDiv = document.getElementById('summaryBackgroundChoices');
        if (Object.keys(backgroundChoices).length > 0) {
            const choicesText = Object.keys(backgroundChoices).map(section => {
                return `${section}: ${backgroundChoices[section]}`;
            }).join(', ');
            backgroundChoicesDiv.querySelector('.choice-value').textContent = choicesText;
            backgroundChoicesDiv.style.display = 'block';
            hasChoices = true;
        } else {
            backgroundChoicesDiv.style.display = 'none';
        }
        
        // Choix de comp√©tences d'historique
        const skillChoicesDiv = document.getElementById('summarySkillChoices');
        if (Object.keys(backgroundSkillChoices).length > 0) {
            const choicesText = Object.values(backgroundSkillChoices).join(', ');
            skillChoicesDiv.querySelector('.choice-value').textContent = choicesText;
            skillChoicesDiv.style.display = 'block';
            hasChoices = true;
        } else {
            skillChoicesDiv.style.display = 'none';
        }
        
        choicesSection.style.display = hasChoices ? 'block' : 'none';
    }

    // Gestion de la navigation entre √©tapes (remplac√©e par les versions async plus bas)

    function updateStepDisplay() {
        // Mettre √† jour les indicateurs de progression
        document.querySelectorAll('.step').forEach((step, index) => {
            step.classList.toggle('active', index + 1 === currentStep);
            step.classList.toggle('completed', index + 1 < currentStep);
        });

        // Mettre √† jour le contenu affich√©
        document.querySelectorAll('.step-content').forEach((content, index) => {
            content.classList.toggle('active', index + 1 === currentStep);
        });
        
        // Mettre √† jour le r√©sum√©
        updateCharacterSummary();
        
        // Charger les r√®gles d'incantation si on arrive √† l'√©tape 3 et qu'une classe est s√©lectionn√©e
        // Mais seulement si elles ne sont pas d√©j√† charg√©es
        if (currentStep === 3 && selectedClass && (!incantationRules || Object.keys(incantationRules).length === 0)) {
            console.log('üîÑ Rechargement des r√®gles d\'incantation pour l\'√©tape 3');
            loadIncantationRulesForStep3();
        } else if (currentStep === 3 && incantationRules && Object.keys(incantationRules).length > 0) {
            // Si les r√®gles sont d√©j√† charg√©es, juste les afficher
            console.log('‚úÖ R√®gles d\'incantation d√©j√† charg√©es, affichage direct');
            displayIncantationRules();
        }
        
        // Remonter en haut de la page
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function validateCurrentStep() {
        switch (currentStep) {
            case 1:
                if (!selectedClass) {
                    alert('Veuillez s√©lectionner une classe');
                    return false;
                }
                break;
            case 2:
                if (!selectedRace) {
                    alert('Veuillez s√©lectionner une race');
                    return false;
                }
                break;
            case 3:
                const characterName = document.getElementById('characterName').value;
                if (!characterName.trim()) {
                    alert('Veuillez entrer un nom pour votre personnage');
                    return false;
                }
                if (!selectedBackground) {
                    alert('Veuillez s√©lectionner un historique');
                    return false;
                }
                // V√©rifier que tous les champs de personnalit√© sont remplis
                const traitValue = document.getElementById('trait-input').value.trim();
                const idealValue = document.getElementById('ideal-input').value.trim();
                const bondValue = document.getElementById('bond-input').value.trim();
                const flawValue = document.getElementById('flaw-input').value.trim();
                
                if (!traitValue || !idealValue || !bondValue || !flawValue) {
                    alert('Veuillez remplir tous les traits de personnalit√© (trait, id√©al, lien, d√©faut)');
                    return false;
                }
                
                // Mettre √† jour selectedPersonality avec les valeurs actuelles
                selectedPersonality.trait = traitValue;
                selectedPersonality.ideal = idealValue;
                selectedPersonality.bond = bondValue;
                selectedPersonality.flaw = flawValue;
                
                // V√©rifier les choix de bonus raciaux si n√©cessaire
                if (selectedRace && racialBonuses[selectedRace] && racialBonuses[selectedRace].choice) {
                    const requiredChoices = racialBonuses[selectedRace].choice;
                    
                    // Compter les checkbox coch√©es
                    const checkedBoxes = document.querySelectorAll('.racial-choice-inline input[type="checkbox"]:checked');
                    const madeChoices = checkedBoxes.length;
                    
                    console.log('Validation choix raciaux √©tape 3:', {
                        selectedRace,
                        requiredChoices,
                        madeChoices,
                        checkedBoxes: Array.from(checkedBoxes).map(cb => cb.name)
                    });
                    
                    if (madeChoices < requiredChoices) {
                        alert(`Vous devez choisir ${requiredChoices} bonus de caract√©ristique pour votre race ${selectedRace}. Actuellement ${madeChoices} choix faits.`);
                        return false;
                    }
                    
                    // Mettre √† jour racialChoices pour la soumission
                    racialChoices = {};
                    checkedBoxes.forEach(checkbox => {
                        const ability = checkbox.name.replace('racial_choice_', '');
                        racialChoices[ability] = 1;
                    });
                }
                
                // V√©rifier que le bon nombre de comp√©tences de classe sont s√©lectionn√©es
                if (!selectedClass || !classSkills[selectedClass]) {
                    alert('Erreur avec la classe s√©lectionn√©e');
                    return false;
                }
                const requiredSkills = classSkills[selectedClass].count;
                if (selectedClassSkills.length !== requiredSkills) {
                    alert(`Vous devez s√©lectionner exactement ${requiredSkills} comp√©tence(s) pour votre classe.`);
                    return false;
                }
                
                // V√©rifier les choix d'historique obligatoires
                if (selectedBackground && backgroundsData[selectedBackground] && 
                    backgroundsData[selectedBackground].choice_sections && 
                    backgroundsData[selectedBackground].choice_sections.length > 0) {
                    
                    const requiredChoices = backgroundsData[selectedBackground].choice_sections.length;
                    const madeChoices = Object.keys(backgroundChoices).length;
                    
                    if (madeChoices < requiredChoices) {
                        alert(`Vous devez faire tous les choix de votre historique. ${madeChoices}/${requiredChoices} choix faits.`);
                        return false;
                    }
                }
                break;
            case 4:
                // L'√©tape 4 est optionnelle, pas de validation stricte
                break;
        }
        return true;
    }

    // Gestion de la s√©lection de classe
    document.querySelectorAll('.class-card').forEach(card => {
        card.addEventListener('click', async function() {
            document.querySelectorAll('.class-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedClass = this.dataset.class;
            document.getElementById('selectedClass').value = selectedClass;
            document.getElementById('summaryClass').textContent = this.querySelector('h3').textContent;
            
            // Charger toutes les donn√©es de classe en une seule fois
            await loadAllClassData();
            
            // Si un historique est d√©j√† s√©lectionn√©, mettre √† jour les comp√©tences
            if (selectedBackground && backgroundsData[selectedBackground]) {
                updateClassSkills();
            }
            
            // Mettre √† jour le r√©sum√© complet
            updateCharacterSummary();
        });
    });

    // Obtenir toutes les comp√©tences acquises par l'historique (fixes + choisies)
    function getAllBackgroundSkills() {
        let allSkills = [];
        
        // Comp√©tences fixes de l'historique
        if (selectedBackground && backgroundsData[selectedBackground]) {
            const background = backgroundsData[selectedBackground];
            
            // Si une variante est s√©lectionn√©e, utiliser ses comp√©tences
            if (selectedVariant && background.variants && background.variants[selectedVariant]) {
                const variant = background.variants[selectedVariant];
                if (variant.skills) {
                    allSkills = [...variant.skills];
                }
            } else if (background.skills) {
                allSkills = [...background.skills];
            }
        }
        
        // Ajouter les comp√©tences choisies
        Object.values(backgroundSkillChoices).forEach(skill => {
            if (skill && !allSkills.includes(skill)) {
                allSkills.push(skill);
            }
        });
        
        return allSkills;
    }

    // Afficher la section des comp√©tences de classe apr√®s s√©lection de l'historique
    function displayClassSkillsSection(background) {
        const container = document.getElementById('class-skills-section-container');
        
        // Mettre √† jour l'affichage des comp√©tences acquises
        updateBackgroundSkillsDisplay();
        
        // Mettre √† jour les comp√©tences de classe disponibles
        updateClassSkills();
        
        // Afficher la section
        container.style.display = 'block';
    }
    
    // Mettre √† jour l'affichage des comp√©tences acquises par l'historique
    function updateBackgroundSkillsDisplay() {
        const skillsSummary = document.getElementById('background-skills-summary');
        const skillsList = document.getElementById('background-skills-list');
        
        const allBackgroundSkills = getAllBackgroundSkills();
        
        if (allBackgroundSkills.length > 0) {
            skillsList.innerHTML = allBackgroundSkills.map(skill => 
                `<div class="skill-acquired-tag">${skill}</div>`
            ).join('');
            skillsSummary.style.display = 'block';
        } else {
            skillsSummary.style.display = 'none';
        }
    }
    
    // Alias pour compatibilit√©
    function updateClassSkillsDisplay() {
        updateBackgroundSkillsDisplay();
        updateClassSkills();
    }

    // Mise √† jour des comp√©tences de classe (avec exclusion des comp√©tences d'historique)
    function updateClassSkills() {
        const skillsSection = document.getElementById('class-skills-section');
        
        if (!selectedClass || !classSkills[selectedClass]) {
            skillsSection.innerHTML = '<p>S√©lectionnez une classe pour voir les comp√©tences disponibles</p>';
            return;
        }

        const classSkillData = classSkills[selectedClass];
        const backgroundSkills = getAllBackgroundSkills();
        selectedClassSkills = []; // Reset des comp√©tences s√©lectionn√©es
        
        skillsSection.innerHTML = `
            <div class="skills-selection">
                <p><strong>Choisissez ${classSkillData.count} comp√©tence(s) parmi :</strong></p>
                <div class="skills-grid">
                    ${classSkillData.available.map(skill => {
                        const isFromBackground = backgroundSkills.includes(skill);
                        return `
                            <label class="skill-checkbox ${isFromBackground ? 'skill-disabled' : ''}">
                                <input type="checkbox" 
                                       name="class_skills" 
                                       value="${skill}" 
                                       ${isFromBackground ? 'disabled' : ''} 
                                       onchange="handleSkillSelection(this)">
                                <span>${skill}</span>
                            </label>
                        `;
                    }).join('')}
                </div>
                <div class="skills-counter">
                    <span id="skills-selected">0</span> / ${classSkillData.count} comp√©tences s√©lectionn√©es
                </div>
            </div>
        `;
        
        // Initialiser l'√©tat des checkbox de comp√©tences
        setTimeout(updateSkillCheckboxStates, 10);
    }

    // Gestion de la s√©lection des comp√©tences
    function handleSkillSelection(checkbox) {
        const maxSkills = classSkills[selectedClass].count;
        
        if (checkbox.checked) {
            if (selectedClassSkills.length >= maxSkills) {
                checkbox.checked = false;
                alert(`Vous ne pouvez s√©lectionner que ${maxSkills} comp√©tence(s) pour cette classe.`);
                return;
            }
            selectedClassSkills.push(checkbox.value);
        } else {
            selectedClassSkills = selectedClassSkills.filter(skill => skill !== checkbox.value);
        }
        
        document.getElementById('skills-selected').textContent = selectedClassSkills.length;
        
        // G√©rer l'√©tat des autres checkbox de comp√©tences
        updateSkillCheckboxStates();
    }

    // Nouvelle fonction pour g√©rer l'√©tat des checkbox de comp√©tences
    function updateSkillCheckboxStates() {
        if (!selectedClass || !classSkills[selectedClass]) {
            return;
        }
        
        const maxSkills = classSkills[selectedClass].count;
        const checkedSkills = document.querySelectorAll('#class-skills-section input[type="checkbox"]:checked');
        const allSkillCheckboxes = document.querySelectorAll('#class-skills-section input[type="checkbox"]');
        
        // Si on a atteint le maximum, d√©sactiver les autres (sauf celles d√©j√† d√©sactiv√©es par l'historique)
        if (checkedSkills.length >= maxSkills) {
            allSkillCheckboxes.forEach(cb => {
                if (!cb.checked && !cb.parentElement.classList.contains('skill-disabled')) {
                    cb.disabled = true;
                    cb.parentElement.classList.add('disabled');
                }
            });
        } else {
            // Sinon, r√©activer toutes les checkbox (sauf celles d√©sactiv√©es par l'historique)
            allSkillCheckboxes.forEach(cb => {
                if (!cb.parentElement.classList.contains('skill-disabled')) {
                    cb.disabled = false;
                    cb.parentElement.classList.remove('disabled');
                }
            });
        }
        
        console.log(`Comp√©tences mises √† jour: ${checkedSkills.length}/${maxSkills} comp√©tences s√©lectionn√©es`);
    }

    // Gestion de la s√©lection de race
    document.querySelectorAll('.race-card').forEach(card => {
        card.addEventListener('click', function() {
            document.querySelectorAll('.race-card').forEach(c => c.classList.remove('selected'));
            this.classList.add('selected');
            selectedRace = this.dataset.race;
            document.getElementById('selectedRace').value = selectedRace;
            document.getElementById('summaryRace').textContent = this.querySelector('h4').textContent;
            updateRacialBonuses();
            updateCharacterSummary();
        });
    });

    // Mise √† jour des bonus raciaux
    function updateRacialBonuses() {
        // Reset tous les bonus et choix
        ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse', 'charisme'].forEach(ability => {
            document.getElementById(`${ability}-bonus`).textContent = '';
            document.getElementById(`${ability}-choice`).style.display = 'none';
        });
        
        // Reset les choix raciaux
        racialChoices = {};
        
        if (!selectedRace || !racialBonuses[selectedRace]) return;
        
        const bonuses = racialBonuses[selectedRace];
        const raceName = selectedRace.charAt(0).toUpperCase() + selectedRace.slice(1);
        
        // Appliquer les bonus fixes
        Object.keys(bonuses).forEach(ability => {
            if (ability !== 'choice' && bonuses[ability] > 0) {
                const bonusElement = document.getElementById(`${ability}-bonus`);
                if (bonusElement) {
                    bonusElement.textContent = `+${bonuses[ability]} ${raceName}`;
                    bonusElement.style.color = '#27ae60';
                }
            }
        });
        
        // G√©rer les bonus au choix (afficher les checkbox inline)
        if (bonuses.choice) {
            showInlineRacialChoices();
        }
        
        // Mettre √† jour tous les modificateurs
        ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse', 'charisme'].forEach(ability => {
            const input = document.getElementById(ability);
            if (input) {
                updateModifier(ability, parseInt(input.value));
            }
        });
        
        // Mettre √† jour le r√©sum√©
        updateCharacterSummary();
    }

    // Afficher les choix de bonus raciaux inline
    function showInlineRacialChoices() {
        console.log('showInlineRacialChoices appel√©e pour:', selectedRace);
        const bonuses = racialBonuses[selectedRace];
        const availableAbilities = ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse', 'charisme']
            .filter(ability => !bonuses[ability]); // Exclure ceux qui ont d√©j√† un bonus fixe
        
        console.log('Capacit√©s disponibles pour les choix:', availableAbilities);
        
        // Afficher les checkbox pour les caract√©ristiques disponibles
        availableAbilities.forEach(ability => {
            const choiceElement = document.getElementById(`${ability}-choice`);
            if (choiceElement) {
                choiceElement.style.display = 'block';
                // Reset la checkbox
                const checkbox = choiceElement.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.checked = false;
                    checkbox.disabled = false;
                    checkbox.parentElement.classList.remove('disabled');
                }
                console.log(`Checkbox ${ability} affich√©e`);
            } else {
                console.error(`Element ${ability}-choice non trouv√©`);
            }
        });
        
        // Initialiser l'√©tat des checkbox
        setTimeout(updateCheckboxStates, 10);
    }

    // Gestion des choix de bonus raciaux inline
    function handleInlineRacialChoice(checkbox, ability) {
        const maxChoices = racialBonuses[selectedRace].choice;
        
        if (checkbox.checked) {
            // Compter les checkbox actuellement coch√©es
            const checkedBoxes = document.querySelectorAll('.racial-choice-inline input[type="checkbox"]:checked');
            
            if (checkedBoxes.length > maxChoices) {
                checkbox.checked = false;
                alert(`Vous ne pouvez faire que ${maxChoices} choix de bonus.`);
                return;
            }
        }
        
        // Mise √† jour en temps r√©el de racialChoices
        updateRacialChoicesFromCheckboxes();
        
        // G√©rer l'√©tat des autres checkbox
        updateCheckboxStates();
        
        // Mettre √† jour les modificateurs
        ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse', 'charisme'].forEach(ability => {
            const input = document.getElementById(ability);
            if (input) {
                updateModifier(ability, parseInt(input.value));
            }
        });
    }

    // Nouvelle fonction pour g√©rer l'√©tat des checkbox
    function updateCheckboxStates() {
        if (!selectedRace || !racialBonuses[selectedRace] || !racialBonuses[selectedRace].choice) {
            return;
        }
        
        const maxChoices = racialBonuses[selectedRace].choice;
        const checkedBoxes = document.querySelectorAll('.racial-choice-inline input[type="checkbox"]:checked');
        const allCheckboxes = document.querySelectorAll('.racial-choice-inline input[type="checkbox"]');
        
        // Si on a atteint le maximum, d√©sactiver les autres
        if (checkedBoxes.length >= maxChoices) {
            allCheckboxes.forEach(cb => {
                if (!cb.checked) {
                    cb.disabled = true;
                    cb.parentElement.classList.add('disabled');
                }
            });
        } else {
            // Sinon, r√©activer toutes les checkbox
            allCheckboxes.forEach(cb => {
                cb.disabled = false;
                cb.parentElement.classList.remove('disabled');
            });
        }
        
        console.log(`√âtats mis √† jour: ${checkedBoxes.length}/${maxChoices} choix faits`);
    }
    
    // Fonction utilitaire pour mettre √† jour racialChoices
    function updateRacialChoicesFromCheckboxes() {
        racialChoices = {};
        const checkedBoxes = document.querySelectorAll('.racial-choice-inline input[type="checkbox"]:checked');
        checkedBoxes.forEach(checkbox => {
            const ability = checkbox.name.replace('racial_choice_', '');
            racialChoices[ability] = 1;
        });
    }

    // Fonction de debug temporaire
    function debugRacialChoices() {
        console.log('=== DEBUG RACIAL CHOICES ===');
        console.log('selectedRace:', selectedRace);
        console.log('racialBonuses:', racialBonuses);
        
        if (selectedRace) {
            console.log('Bonus pour cette race:', racialBonuses[selectedRace]);
        }
        
        // Forcer l'affichage des choix
        const abilities = ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse'];
        abilities.forEach(ability => {
            const choiceElement = document.getElementById(`${ability}-choice`);
            if (choiceElement) {
                choiceElement.style.display = 'block';
                console.log(`${ability}-choice forc√© √† visible`);
            } else {
                console.error(`${ability}-choice introuvable`);
            }
        });
        
        // V√©rifier les checkbox
        const allCheckboxes = document.querySelectorAll('.racial-choice-inline input[type="checkbox"]');
        console.log('Checkbox trouv√©es:', allCheckboxes.length);
        allCheckboxes.forEach((cb, index) => {
            console.log(`Checkbox ${index}:`, cb.name, 'visible:', cb.offsetParent !== null);
        });
    }



    // Supprim√© - g√©r√© maintenant dans displayBackgrounds() avec les historiques dynamiques

    // Gestion des caract√©ristiques
    function adjustScore(ability, change) {
        const input = document.getElementById(ability);
        const currentValue = parseInt(input.value);
        const newValue = currentValue + change;
        
        if (newValue >= 8 && newValue <= 15) {
            const currentCost = pointCosts[currentValue];
            const newCost = pointCosts[newValue];
            const costDifference = newCost - currentCost;
            
            if (usedPoints + costDifference <= totalPoints) {
                input.value = newValue;
                usedPoints += costDifference;
                updateModifier(ability, newValue);
                updatePointsDisplay();
                updateCharacterSummary();
            }
        }
    }

    // Obtenir le bonus racial total pour une caract√©ristique
    function getRacialBonus(ability) {
        if (!selectedRace || !racialBonuses[selectedRace]) return 0;
        
        const bonuses = racialBonuses[selectedRace];
        let totalBonus = 0;
        
        // Bonus fixe
        if (bonuses[ability]) {
            totalBonus += bonuses[ability];
        }
        
        // Bonus au choix
        if (racialChoices[ability]) {
            totalBonus += racialChoices[ability];
        }
        
        return totalBonus;
    }

    function updateModifier(ability, baseScore) {
        const racialBonus = getRacialBonus(ability);
        const finalScore = baseScore + racialBonus;
        const modifier = Math.floor((finalScore - 10) / 2);
        const modifierText = modifier >= 0 ? `+${modifier}` : `${modifier}`;
        
        // Mettre √† jour l'affichage du modificateur avec plus de visibilit√©
        const modElement = document.getElementById(`${ability}-mod`);
        modElement.innerHTML = `<span class="modifier-value">${modifierText}</span>`;
        
        // Afficher le score final si diff√©rent du score de base
        const scoreDisplay = document.getElementById(`${ability}-final-score`);
        if (scoreDisplay) {
            if (racialBonus > 0) {
                scoreDisplay.textContent = `= ${finalScore}`;
                scoreDisplay.style.display = 'inline';
            } else {
                scoreDisplay.style.display = 'none';
            }
        }
    }

    function updatePointsDisplay() {
        document.getElementById('pointsRemaining').textContent = totalPoints - usedPoints;
    }

    // Pr√©paration des donn√©es avant soumission
    document.getElementById('characterForm').addEventListener('submit', function(e) {
        // Remplir les champs cach√©s existants
        document.getElementById('classSkillsInput').value = JSON.stringify(selectedClassSkills);
        document.getElementById('racialChoicesInput').value = JSON.stringify(racialChoices);
        
        // Remplir les nouveaux champs cach√©s pour la progression
        document.getElementById('selectedSubclassInput').value = selectedSubclass || '';
        document.getElementById('selectedMulticlassInput').value = selectedMulticlass || '';
        document.getElementById('progressionChoiceInput').value = progressionChoice || 'single';
        document.getElementById('selectedSpellsInput').value = JSON.stringify(selectedSpells || []);
        
        // Remplir les champs cach√©s pour l'√©quipement
        document.getElementById('selectedArmorInput').value = document.getElementById('armorSelect')?.value || '';
        document.getElementById('selectedShieldInput').value = document.getElementById('shieldSelect')?.value || '';
        document.getElementById('selectedMainWeaponInput').value = document.getElementById('mainWeaponSelect')?.value || '';
        document.getElementById('selectedSecondaryWeaponInput').value = document.getElementById('secondaryWeaponSelect')?.value || '';
        document.getElementById('selectedBackupWeaponInput').value = document.getElementById('backupWeaponSelect')?.value || '';
        
        // R√©cup√©rer les objets d'inventaire s√©lectionn√©s
        const selectedInventory = [];
        document.querySelectorAll('input[name="inventory_items"]:checked').forEach(checkbox => {
            selectedInventory.push(checkbox.value);
        });
        document.getElementById('selectedInventoryInput').value = JSON.stringify(selectedInventory);
        
        // R√©cup√©rer l'√©quipement personnalis√©
        const customEquipment = document.getElementById('customEquipment')?.value || '';
        
        console.log('üìã Donn√©es de progression envoy√©es:', {
            subclass: selectedSubclass,
            multiclass: selectedMulticlass,
            progression: progressionChoice,
            spells: selectedSpells?.length || 0
        });
        
        console.log('‚öîÔ∏è Donn√©es d\'√©quipement envoy√©es:', {
            armor: document.getElementById('armorSelect')?.value || 'Aucune',
            shield: document.getElementById('shieldSelect')?.value || 'Aucun',
            mainWeapon: document.getElementById('mainWeaponSelect')?.value || 'Aucune',
            secondaryWeapon: document.getElementById('secondaryWeaponSelect')?.value || 'Aucune',
            backupWeapon: document.getElementById('backupWeaponSelect')?.value || 'Aucune',
            inventory: selectedInventory.length,
            customEquipment: customEquipment ? 'Oui' : 'Non'
        });
    });

    // Variables pour l'√©tape 4
    let currentTab = 'spells';
    let availableSpells = [];
            // selectedSpells d√©j√† d√©clar√© globalement
    let classAbilities = [];
    let racialTraits = [];
    let spellLimitations = {};
    let incantationRules = {};

    // Gestion des onglets √©tape 4
    function initializeStep4() {
        // Supprimer les anciens event listeners pour √©viter les doublons
        document.querySelectorAll('.tab-button').forEach(button => {
            const newButton = button.cloneNode(true);
            button.parentNode.replaceChild(newButton, button);
        });
        
        // Event listeners pour les onglets
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                const tabId = this.dataset.tab;
                switchTab(tabId);
            });
        });

        // Event listeners pour les filtres
        const levelFilter = document.getElementById('spellLevelFilter');
        const schoolFilter = document.getElementById('spellSchoolFilter');
        
        if (levelFilter) {
            const newLevelFilter = levelFilter.cloneNode(true);
            levelFilter.parentNode.replaceChild(newLevelFilter, levelFilter);
            newLevelFilter.addEventListener('change', filterSpells);
        }
        
        if (schoolFilter) {
            const newSchoolFilter = schoolFilter.cloneNode(true);
            schoolFilter.parentNode.replaceChild(newSchoolFilter, schoolFilter);
            newSchoolFilter.addEventListener('change', filterSpells);
        }
    }

    function switchTab(tabId) {
        // Mettre √† jour les boutons
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabId}"]`).classList.add('active');

        // Mettre √† jour le contenu
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(`${tabId}-tab`).classList.add('active');

        currentTab = tabId;
    }

    // Charger les donn√©es pour l'√©tape 4
    async function loadStep4Data() {
        if (!selectedClass || !selectedRace) {
            alert('Veuillez d\'abord s√©lectionner une classe et une race.');
            return false;
        }

        document.getElementById('loadingSpells').style.display = 'block';
        document.getElementById('classNameForSpells').textContent = selectedClass;

        try {
            // Appel AJAX pour r√©cup√©rer les donn√©es
            const response = await fetch('/api/character-spells-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    class: selectedClass,
                    race: selectedRace,
                    level: getCharacterLevel()
                })
            });

            if (!response.ok) {
                throw new Error('Erreur lors du chargement des donn√©es');
            }

            const data = await response.json();
            
            availableSpells = data.spells || [];
            classAbilities = data.abilities || [];
            racialTraits = data.racial_traits || [];
            spellLimitations = data.spell_limitations || {};
            incantationRules = data.incantation_rules || {};

            // Afficher les donn√©es
            displaySpellLimitations();
            displayIncantationRules();
            displaySpells();
            displayClassAbilities();
            displayRacialTraits();

            document.getElementById('loadingSpells').style.display = 'none';
            return true;

        } catch (error) {
            console.error('Erreur:', error);
            document.getElementById('loadingSpells').style.display = 'none';
            alert('Erreur lors du chargement des donn√©es. Veuillez r√©essayer.');
            return false;
        }
    }

    // Affichage des limitations de sorts
    function displaySpellLimitations() {
        const header = document.querySelector('.spells-header h3');
        if (header && spellLimitations) {
            const cantrips = spellLimitations.cantrips_known || 0;
            const spells = spellLimitations.prepares_spells ? 
                (spellLimitations.spells_preparable || 0) : 
                (spellLimitations.spells_known || 0);
            const spellType = spellLimitations.prepares_spells ? 'sorts pr√©parables' : 'sorts connus';
            const currentLevel = getCharacterLevel();
            const slots = Object.entries(spellLimitations.spell_slots || {})
                .map(([level, count]) => `${count} niv.${level}`)
                .join(', ');
            
            header.innerHTML = `
                Sorts disponibles pour <span id="classNameForSpells">${selectedClass}</span>
                <div class="spell-limits">
                    <small>Limites niveau ${currentLevel}: ${cantrips} tours de magie, ${spells} ${spellType}, emplacements: ${slots || 'aucun'}</small>
                </div>
            `;
        }
    }

    // Charger toutes les donn√©es de classe en une seule fois
    async function loadAllClassData() {
        if (!selectedClass) return;
        
        try {
            const response = await fetch('/api/character-spells-data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    class: selectedClass,  // L'API attend 'class'
                    character_class: selectedClass,  // Garder pour compatibilit√©
                    level: getCharacterLevel()
                })
            });
            
            if (response.ok) {
                const data = await response.json();
                
                // Charger toutes les donn√©es en une fois
                classAbilities = data.abilities || [];
                spellLimitations = data.spell_limitations || {};
                incantationRules = data.incantation_rules || {};
                
                // Afficher imm√©diatement les r√®gles d'incantation
                displayIncantationRules();
                
                console.log(`‚úÖ Donn√©es compl√®tes charg√©es pour ${selectedClass}:`);
                console.log('- Aptitudes:', classAbilities.length, 'niveaux');
                console.log('- Limitations:', spellLimitations);
                console.log('- R√®gles d\'incantation:', incantationRules);
            }
        } catch (error) {
            console.error('Erreur lors du chargement des donn√©es de classe:', error);
        }
    }

    // Charger les donn√©es de classe (aptitudes) - fonction de compatibilit√©
    async function loadClassData() {
        await loadAllClassData();
    }

    // Charger les r√®gles d'incantation pour l'√©tape 3 - utilise maintenant loadAllClassData
    async function loadIncantationRulesForStep3() {
        console.log('üîÑ Rechargement via loadAllClassData');
        await loadAllClassData();
    }

    // Affichage des r√®gles d'incantation
    function displayIncantationRules() {
        const container = document.getElementById('incantation-rules-container');
        
        // Vider le conteneur
        container.innerHTML = '';
        
        if (incantationRules && Object.keys(incantationRules).length > 0) {
            const rulesDiv = document.createElement('div');
            rulesDiv.className = 'incantation-rules';
            rulesDiv.innerHTML = `
                <div class="rules-header">
                    <h4>üìú R√®gles d'incantation</h4>
                </div>
                <div class="rules-content">
                    <div class="rule-item">
                        <strong>Caract√©ristique d'incantation:</strong> ${incantationRules.casting_ability || 'Charisme'}
                    </div>
                    ${incantationRules.ritual_casting ? '<div class="rule-item"><strong>Incantation rituelle:</strong> Oui</div>' : ''}
                    ${incantationRules.spellcasting_focus ? `<div class="rule-item"><strong>Focaliseur:</strong> ${incantationRules.spellcasting_focus}</div>` : ''}
                    ${incantationRules.description ? `<div class="rule-description">${incantationRules.description}</div>` : ''}
                </div>
            `;
            
            // Ajouter au conteneur et afficher la section
            container.appendChild(rulesDiv);
            container.style.display = 'block';
        } else {
            // Masquer la section si pas de r√®gles
            container.style.display = 'none';
        }
    }

    // Affichage des sorts
    function displaySpells() {
        const container = document.getElementById('spellsList');
        container.innerHTML = '';

        if (availableSpells.length === 0) {
            container.innerHTML = '<p class="empty-state">Aucun sort disponible pour cette classe.</p>';
            return;
        }

        availableSpells.forEach(spell => {
            const spellCard = document.createElement('div');
            spellCard.className = 'spell-card-compact';
            spellCard.dataset.level = spell.level;
            spellCard.dataset.school = spell.school;
            
            const isSelected = selectedSpells.some(s => s.title === spell.title);
            
            spellCard.innerHTML = `
                <div class="spell-compact-content">
                    <div class="spell-compact-info">
                        <span class="spell-compact-title">${spell.title}</span>
                        <span class="spell-compact-level">${spell.level === 0 ? 'Tour' : 'Niv.' + spell.level}</span>
                    </div>
                    <div class="spell-compact-actions">
                        <button type="button" class="spell-details-btn" onclick="showSpellDetails('${spell.title}', event)" title="Voir les d√©tails">
                            üîç
                        </button>
                        <button type="button" class="spell-select-btn ${isSelected ? 'selected' : ''}" onclick="toggleSpellSelectionCompact('${spell.title}', this, event)" title="${isSelected ? 'D√©s√©lectionner' : 'S√©lectionner'}">
                            ${isSelected ? '‚úì' : '+'}
                        </button>
                    </div>
                </div>
            `;

            container.appendChild(spellCard);
        });
    }

    // Charger les donn√©es d'√©quipement
    async function loadEquipmentData() {
        try {
            const response = await fetch('/api/equipment');
            const result = await response.json();
            
            if (result.success) {
                equipmentData = result.data;
                const classElement = document.getElementById('selectedClass');
                currentClass = classElement ? classElement.value : '';
                
                // Charger les armures
                loadArmors();
                
                // Charger les armes
                loadWeapons();
                
                // Charger l'inventaire
                loadInventory();
                
                // Initialiser les contr√¥les d'√©quipement
                setupEquipmentControls();
                
                console.log('Donn√©es d\'√©quipement charg√©es:', equipmentData);
            } else {
                console.error('Erreur lors du chargement de l\'√©quipement:', result.error);
            }
        } catch (error) {
            console.error('Erreur lors du chargement de l\'√©quipement:', error);
        }
    }

    // Charger les armures dans le select
    function loadArmors() {
        const armorSelect = document.getElementById('armorSelect');
        const shieldSelect = document.getElementById('shieldSelect');
        
        // Vider les options existantes
        armorSelect.innerHTML = '<option value="">Choisir une armure...</option>';
        
        // Ajouter les armures (exclure le bouclier) avec indicateurs de ma√Ætrise
        equipmentData.armors.forEach(armor => {
            if (armor.type !== 'bouclier') {
                const isProficient = checkArmorProficiency(armor.name);
                const proficiencyText = isProficient ? ' ‚úì' : ' ‚úó';
                const typeText = armor.type === 'l√©g√®re' ? ' [L√©g√®re]' : 
                               armor.type === 'interm√©diaire' ? ' [Interm√©diaire]' : ' [Lourde]';
                
                const option = document.createElement('option');
                option.value = armor.name;
                option.textContent = `${armor.name} (CA ${armor.ca}) - ${armor.price}${typeText}${proficiencyText}`;
                option.dataset.type = armor.type;
                option.dataset.ca = armor.ca;
                option.dataset.price = armor.price;
                option.dataset.weight = armor.weight;
                option.dataset.proficient = isProficient;
                armorSelect.appendChild(option);
            }
        });
        
        // G√©rer les changements d'armure
        armorSelect.addEventListener('change', function() {
            updateArmorProficiency(this.value);
            updateEquipmentCalculations();
        });
        
        // G√©rer les changements de bouclier
        shieldSelect.addEventListener('change', function() {
            hasShield = this.value !== '';
            updateShieldProficiency(this.value);
            updateWeaponRestrictions();
        });
    }

    // Charger les armes dans les selects
    function loadWeapons() {
        const mainWeaponSelect = document.getElementById('mainWeaponSelect');
        const secondaryWeaponSelect = document.getElementById('secondaryWeaponSelect');
        const backupWeaponSelect = document.getElementById('backupWeaponSelect');
        
        // Vider les options existantes
        mainWeaponSelect.innerHTML = '<option value="">Choisir une arme...</option>';
        secondaryWeaponSelect.innerHTML = '<option value="">Pas d\'arme secondaire</option>';
        backupWeaponSelect.innerHTML = '<option value="">Pas d\'arme de secours</option>';
        
        // Ajouter les armes avec indicateurs de ma√Ætrise
        equipmentData.weapons.forEach(weapon => {
            const isProficient = checkWeaponProficiency(weapon.name);
            const proficiencyText = isProficient ? ' ‚úì' : ' ‚úó';
            const typeText = weapon.type === 'guerre' ? ' [Guerre]' : ' [Courante]';
            
            const option = document.createElement('option');
            option.value = weapon.name;
            option.textContent = `${weapon.name} (${weapon.damage}) - ${weapon.price}${typeText}${proficiencyText}`;
            option.dataset.type = weapon.type;
            option.dataset.range = weapon.range;
            option.dataset.damage = weapon.damage;
            option.dataset.properties = weapon.properties;
            option.dataset.price = weapon.price;
            option.dataset.weight = weapon.weight;
            option.dataset.proficient = isProficient;
            
            // Ajouter √† tous les selects d'armes
            mainWeaponSelect.appendChild(option.cloneNode(true));
            secondaryWeaponSelect.appendChild(option.cloneNode(true));
            backupWeaponSelect.appendChild(option.cloneNode(true));
        });
        
        // G√©rer les changements d'armes
        mainWeaponSelect.addEventListener('change', function() {
            updateWeaponProficiency(this.value, 'main');
            updateWeaponRestrictions();
        });
        
        secondaryWeaponSelect.addEventListener('change', function() {
            updateWeaponProficiency(this.value, 'secondary');
            updateEquipmentCalculations();
        });
        
        backupWeaponSelect.addEventListener('change', function() {
            updateWeaponProficiency(this.value, 'backup');
            updateEquipmentCalculations();
        });
    }

    // Charger l'inventaire par cat√©gories
    function loadInventory() {
        const inventoryGrid = document.querySelector('.inventory-grid');
        
        // Grouper les objets par cat√©gorie
        const categories = {};
        equipmentData.equipment.forEach(item => {
            const category = item.category || 'Divers';
            if (!categories[category]) {
                categories[category] = [];
            }
            categories[category].push(item);
        });
        
        // Cr√©er les sections par cat√©gorie
        inventoryGrid.innerHTML = '';
        Object.keys(categories).forEach(categoryName => {
            const categoryDiv = document.createElement('div');
            categoryDiv.className = 'inventory-category';
            
            const categoryTitle = document.createElement('h4');
            categoryTitle.textContent = categoryName;
            categoryDiv.appendChild(categoryTitle);
            
            const itemsDiv = document.createElement('div');
            itemsDiv.className = 'inventory-items';
            
            categories[categoryName].forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'inventory-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `item_${item.name.replace(/\s+/g, '_')}`;
                checkbox.name = 'inventory_items';
                checkbox.value = item.name;
                
                // Gestionnaire d'√©v√©nement pour les calculs
                checkbox.addEventListener('change', function() {
                    if (this.checked) {
                        selectedInventory.push(item.name);
                    } else {
                        const index = selectedInventory.indexOf(item.name);
                        if (index > -1) {
                            selectedInventory.splice(index, 1);
                        }
                    }
                    updateEquipmentCalculations();
                });
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.innerHTML = `
                    <span>${item.name}</span>
                    <div>
                        <span class="item-price">${item.price}</span>
                        <span class="item-weight">${item.weight}</span>
                    </div>
                `;
                
                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                itemsDiv.appendChild(itemDiv);
            });
            
            categoryDiv.appendChild(itemsDiv);
            inventoryGrid.appendChild(categoryDiv);
        });
    }

    // Mettre √† jour l'indicateur de ma√Ætrise d'armure
    function updateArmorProficiency(armorName) {
        const indicator = document.getElementById('armorProficiency');
        
        if (!armorName) {
            indicator.textContent = '';
            indicator.className = 'proficiency-indicator';
            return;
        }
        
        const isProficient = checkArmorProficiency(armorName);
        indicator.textContent = isProficient ? '‚úì Ma√Ætris√©' : '‚úó Non ma√Ætris√©';
        indicator.className = `proficiency-indicator ${isProficient ? 'proficient' : 'not-proficient'}`;
    }

    // Mettre √† jour l'indicateur de ma√Ætrise de bouclier
    function updateShieldProficiency(shieldName) {
        const indicator = document.getElementById('shieldProficiency');
        
        if (!shieldName) {
            indicator.textContent = '';
            indicator.className = 'proficiency-indicator';
            return;
        }
        
        const isProficient = checkArmorProficiency('Bouclier');
        indicator.textContent = isProficient ? '‚úì Ma√Ætris√©' : '‚úó Non ma√Ætris√©';
        indicator.className = `proficiency-indicator ${isProficient ? 'proficient' : 'not-proficient'}`;
    }

    // Mettre √† jour l'indicateur de ma√Ætrise d'arme
    function updateWeaponProficiency(weaponName, weaponSlot) {
        const indicator = document.getElementById(`${weaponSlot}WeaponProficiency`);
        
        if (!weaponName) {
            indicator.textContent = '';
            indicator.className = 'proficiency-indicator';
            return;
        }
        
        const isProficient = checkWeaponProficiency(weaponName);
        indicator.textContent = isProficient ? '‚úì Ma√Ætris√©' : '‚úó Non ma√Ætris√©';
        indicator.className = `proficiency-indicator ${isProficient ? 'proficient' : 'not-proficient'}`;
    }

    // Mettre √† jour les restrictions d'armes
    function updateWeaponRestrictions() {
        const mainWeaponSelect = document.getElementById('mainWeaponSelect');
        const secondaryWeaponSelect = document.getElementById('secondaryWeaponSelect');
        const mainRestriction = document.getElementById('mainWeaponRestriction');
        const secondaryRestriction = document.getElementById('secondaryWeaponRestriction');
        const twoHandedAlert = document.getElementById('twoHandedAlert');
        
        // V√©rifier l'arme principale
        const mainWeapon = mainWeaponSelect.value;
        const mainWeaponData = equipmentData?.weapons.find(w => w.name === mainWeapon);
        const isTwoHanded = mainWeaponData && (
            mainWeaponData.properties.includes('√† deux mains') || 
            mainWeaponData.properties.includes('deux mains')
        );
        
        if (hasShield && isTwoHanded) {
            // Arme √† deux mains avec bouclier = impossible
            mainRestriction.textContent = 'Arme √† deux mains uniquement';
            mainRestriction.classList.remove('hidden');
            twoHandedAlert.classList.remove('hidden');
        } else if (hasShield) {
            // Avec bouclier, seules les armes √† une main sont possibles
            mainRestriction.textContent = 'Arme √† une main uniquement';
            mainRestriction.classList.remove('hidden');
            twoHandedAlert.classList.add('hidden');
        } else {
            mainRestriction.classList.add('hidden');
            twoHandedAlert.classList.add('hidden');
        }
        
        // Restrictions pour l'arme secondaire
        if (hasShield || isTwoHanded) {
            secondaryWeaponSelect.disabled = true;
            secondaryWeaponSelect.value = '';
            if (hasShield) {
                secondaryRestriction.textContent = 'Impossible avec bouclier';
            } else if (isTwoHanded) {
                secondaryRestriction.textContent = 'Impossible avec arme √† deux mains';
            }
            secondaryRestriction.classList.remove('hidden');
        } else {
            secondaryWeaponSelect.disabled = false;
            secondaryRestriction.classList.add('hidden');
        }
        
        // Mettre √† jour les calculs d'√©quipement
        updateEquipmentCalculations();
    }

    // Calculer et afficher les totaux d'√©quipement
    function updateEquipmentCalculations() {
        let totalValue = 0;
        let totalWeight = 0;
        let totalItems = 0;

        // Calculer l'armure
        const armorSelect = document.getElementById('armorSelect');
        if (armorSelect.value) {
            const armor = equipmentData.armors.find(a => a.name === armorSelect.value);
            if (armor) {
                totalValue += parsePrice(armor.price);
                totalWeight += parseWeight(armor.weight);
                totalItems++;
            }
        }

        // Calculer le bouclier
        const shieldSelect = document.getElementById('shieldSelect');
        if (shieldSelect.value) {
            const shield = equipmentData.armors.find(a => a.name === shieldSelect.value);
            if (shield) {
                totalValue += parsePrice(shield.price);
                totalWeight += parseWeight(shield.weight);
                totalItems++;
            }
        }

        // Calculer les armes
        ['mainWeaponSelect', 'secondaryWeaponSelect', 'backupWeaponSelect'].forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select.value) {
                const weapon = equipmentData.weapons.find(w => w.name === select.value);
                if (weapon) {
                    totalValue += parsePrice(weapon.price);
                    totalWeight += parseWeight(weapon.weight);
                    totalItems++;
                }
            }
        });

        // Calculer l'inventaire
        selectedInventory.forEach(itemName => {
            const item = equipmentData.equipment.find(e => e.name === itemName);
            if (item) {
                totalValue += parsePrice(item.price);
                totalWeight += parseWeight(item.weight);
                totalItems++;
            }
        });

        // Mettre √† jour l'affichage
        updateLimitDisplays(totalValue, totalWeight, totalItems);
        
        // Mettre √† jour les alertes
        updateEquipmentAlerts(totalValue, totalWeight);
    }

    // Mettre √† jour l'affichage des limites
    function updateLimitDisplays(totalValue, totalWeight, totalItems) {
        const valueElement = document.getElementById('totalValue');
        const weightElement = document.getElementById('totalWeight');
        const itemsElement = document.getElementById('totalItems');

        // Valeur (arrondie √† 2 d√©cimales)
        const roundedValue = Math.round(totalValue * 100) / 100;
        valueElement.textContent = `${roundedValue} po`;
        if (maxValue > 0 && roundedValue > maxValue) {
            valueElement.className = 'limit-value error';
        } else if (maxValue > 0 && roundedValue > maxValue * 0.8) {
            valueElement.className = 'limit-value warning';
        } else {
            valueElement.className = 'limit-value ok';
        }

        // Poids (arrondi √† 1 d√©cimale)
        const roundedWeight = Math.round(totalWeight * 10) / 10;
        weightElement.textContent = `${roundedWeight} kg`;
        if (maxWeight > 0 && roundedWeight > maxWeight) {
            weightElement.className = 'limit-value error';
        } else if (maxWeight > 0 && roundedWeight > maxWeight * 0.8) {
            weightElement.className = 'limit-value warning';
        } else {
            weightElement.className = 'limit-value ok';
        }

        // Objets
        itemsElement.textContent = totalItems.toString();
        itemsElement.className = 'limit-value ok';
    }

    // Mettre √† jour les alertes d'√©quipement
    function updateEquipmentAlerts(totalValue, totalWeight) {
        const weightAlert = document.getElementById('weightAlert');
        const valueAlert = document.getElementById('valueAlert');

        // Arrondir les valeurs pour √©viter les probl√®mes de virgule flottante
        const roundedValue = Math.round(totalValue * 100) / 100;
        const roundedWeight = Math.round(totalWeight * 10) / 10;

        // Alerte de poids
        if (maxWeight > 0 && roundedWeight > maxWeight) {
            weightAlert.textContent = `‚öñÔ∏è Poids d√©pass√©: ${roundedWeight}kg / ${maxWeight}kg`;
            weightAlert.classList.remove('hidden');
        } else {
            weightAlert.classList.add('hidden');
        }

        // Alerte de valeur
        if (maxValue > 0 && roundedValue > maxValue) {
            valueAlert.textContent = `üí∞ Valeur d√©pass√©e: ${roundedValue}po / ${maxValue}po`;
            valueAlert.classList.remove('hidden');
        } else {
            valueAlert.classList.add('hidden');
        }
    }

    // Fonctions utilitaires pour parser les prix et poids
    function parsePrice(priceStr) {
        if (!priceStr || priceStr === '-') return 0;
        
        // Convertir tout en pi√®ces d'or
        const match = priceStr.match(/(\d+(?:,\d+)?)\s*(po|pa|pc)/);
        if (!match) return 0;
        
        const value = parseFloat(match[1].replace(',', '.'));
        const unit = match[2];
        
        let result = 0;
        switch (unit) {
            case 'po': result = value; break;
            case 'pa': result = value / 10; break;
            case 'pc': result = value / 100; break;
            default: result = 0;
        }
        
        // Arrondir √† 2 d√©cimales pour √©viter les probl√®mes de virgule flottante
        return Math.round(result * 100) / 100;
    }

    function parseWeight(weightStr) {
        if (!weightStr || weightStr === '-') return 0;
        
        const match = weightStr.match(/(\d+(?:,\d+)?)/);
        if (!match) return 0;
        
        const result = parseFloat(match[1].replace(',', '.'));
        
        // Arrondir √† 1 d√©cimale pour √©viter les probl√®mes de virgule flottante
        return Math.round(result * 10) / 10;
    }

    // Gestionnaires d'√©v√©nements pour les contr√¥les de limite
    function setupEquipmentControls() {
        const maxValueInput = document.getElementById('maxValue');
        const maxWeightInput = document.getElementById('maxWeight');

        maxValueInput.addEventListener('input', function() {
            maxValue = parseFloat(this.value) || 0;
            updateEquipmentCalculations();
        });

        maxWeightInput.addEventListener('input', function() {
            maxWeight = parseFloat(this.value) || 0;
            updateEquipmentCalculations();
        });
    }

    // V√©rifier la ma√Ætrise d'armure
    function checkArmorProficiency(armorName) {
        if (!currentClass || !equipmentData) return false;
        
        const proficiencies = equipmentData.proficiencies[currentClass];
        if (!proficiencies) return false;
        
        const armorProf = proficiencies.armors.toLowerCase();
        const armorLower = armorName.toLowerCase();
        
        // V√©rifications sp√©cifiques
        if (armorProf.includes('toutes les armures')) {
            return true;
        } else if (armorProf.includes('armures l√©g√®res') && isLightArmor(armorName)) {
            return true;
        } else if (armorProf.includes('armures interm√©diaires') && isMediumArmor(armorName)) {
            return true;
        } else if (armorProf.includes('armures lourdes') && isHeavyArmor(armorName)) {
            return true;
        } else if (armorProf.includes('boucliers') && armorLower.includes('bouclier')) {
            return true;
        }
        
        return false;
    }

    // V√©rifier la ma√Ætrise d'arme
    function checkWeaponProficiency(weaponName) {
        if (!currentClass || !equipmentData) return false;
        
        const proficiencies = equipmentData.proficiencies[currentClass];
        if (!proficiencies) return false;
        
        const weaponProf = proficiencies.weapons.toLowerCase();
        const weaponLower = weaponName.toLowerCase();
        
        // V√©rifications sp√©cifiques
        if (weaponProf.includes('armes de guerre') || weaponProf.includes('armes courantes')) {
            return true;
        } else if (weaponProf.includes(weaponLower)) {
            return true;
        }
        
        return false;
    }

    // Fonctions utilitaires pour les types d'armures
    function isLightArmor(armorName) {
        const lightArmors = ['matelass√©e', 'cuir', 'cuir clout√©'];
        return lightArmors.some(armor => armorName.toLowerCase().includes(armor));
    }

    function isMediumArmor(armorName) {
        const mediumArmors = ['peau', 'chemise', '√©cailles', 'cuirasse', 'demi-plate'];
        return mediumArmors.some(armor => armorName.toLowerCase().includes(armor));
    }

    function isHeavyArmor(armorName) {
        const heavyArmors = ['broigne', 'cotte', 'clibanion', 'harnois'];
        return heavyArmors.some(armor => armorName.toLowerCase().includes(armor));
    }

    // Affichage des aptitudes de classe
    function displayClassAbilities() {
        const container = document.getElementById('combatAbilitiesList');
        container.innerHTML = '';

        if (classAbilities.length === 0) {
            container.innerHTML = '<p class="empty-state">Aucune aptitude trouv√©e.</p>';
            return;
        }

        classAbilities.forEach(levelData => {
            const levelDiv = document.createElement('div');
            levelDiv.className = 'level-abilities';
            
            levelDiv.innerHTML = `
                <div class="level-header">
                    <div class="level-number">${levelData.level}</div>
                    <h4 class="level-title">Niveau ${levelData.level}</h4>
                </div>
                <div class="abilities-list">
                    ${levelData.abilities.map(ability => `
                        <div class="ability-item">
                            <div class="ability-name">${ability.name}</div>
                            <div class="ability-description">${ability.description}</div>
                        </div>
                    `).join('')}
                </div>
            `;

            container.appendChild(levelDiv);
        });
    }

    // Affichage des traits raciaux
    function displayRacialTraits() {
        const container = document.getElementById('racialTraitsList');
        container.innerHTML = '';

        if (racialTraits.length === 0) {
            container.innerHTML = '<p class="empty-state">Aucun trait racial pertinent trouv√©.</p>';
            return;
        }

        racialTraits.forEach(trait => {
            const traitDiv = document.createElement('div');
            traitDiv.className = 'racial-trait';
            
            traitDiv.innerHTML = `
                <div class="trait-name">${trait.name}</div>
                <div class="trait-description">${trait.description}</div>
                ${trait.impact ? `<div class="trait-impact">Impact: ${trait.impact}</div>` : ''}
            `;

            container.appendChild(traitDiv);
        });
    }

    // Gestion de la s√©lection des sorts (version compacte)
    function toggleSpellSelectionCompact(spellTitle, buttonElement, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const spell = availableSpells.find(s => s.title === spellTitle);
        if (!spell) return;
        
        const spellIndex = selectedSpells.findIndex(s => s.title === spellTitle);
        
        if (spellIndex === -1) {
            // V√©rifier les limitations avant d'ajouter
            if (!canSelectSpell(spell)) {
                return;
            }
            
            // Ajouter le sort
            selectedSpells.push(spell);
            buttonElement.classList.add('selected');
            buttonElement.innerHTML = '‚úì';
            buttonElement.title = 'D√©s√©lectionner';
        } else {
            // Retirer le sort
            selectedSpells.splice(spellIndex, 1);
            buttonElement.classList.remove('selected');
            buttonElement.innerHTML = '+';
            buttonElement.title = 'S√©lectionner';
        }
        
        updateSelectedSpellsDisplay();
        updateSpellSelectionLimits();
    }

    // Afficher les d√©tails d'un sort dans une modal
    function showSpellDetails(spellTitle, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const spell = availableSpells.find(s => s.title === spellTitle);
        if (!spell) return;
        
        // Cr√©er ou mettre √† jour la modal
        let modal = document.getElementById('spellDetailsModal');
        if (!modal) {
            modal = document.createElement('div');
            modal.id = 'spellDetailsModal';
            modal.className = 'spell-modal';
            document.body.appendChild(modal);
        }
        
        modal.innerHTML = `
            <div class="spell-modal-content">
                <div class="spell-modal-header">
                    <h3>${spell.title}</h3>
                    <button type="button" class="spell-modal-close" onclick="closeSpellDetails(event)">√ó</button>
                </div>
                <div class="spell-modal-body">
                    <div class="spell-modal-meta">
                        <div class="spell-meta-row">
                            <span class="spell-meta-label">Niveau:</span>
                            <span class="spell-meta-value">${spell.level === 0 ? 'Tour de magie' : 'Niveau ' + spell.level}</span>
                        </div>
                        <div class="spell-meta-row">
                            <span class="spell-meta-label">√âcole:</span>
                            <span class="spell-meta-value">${spell.school}</span>
                        </div>
                        <div class="spell-meta-row">
                            <span class="spell-meta-label">Port√©e:</span>
                            <span class="spell-meta-value">${spell.range || 'N/A'}</span>
                        </div>
                        <div class="spell-meta-row">
                            <span class="spell-meta-label">Dur√©e:</span>
                            <span class="spell-meta-value">${spell.duration || 'N/A'}</span>
                        </div>
                        <div class="spell-meta-row">
                            <span class="spell-meta-label">Temps d'incantation:</span>
                            <span class="spell-meta-value">${spell.casting_time || 'N/A'}</span>
                        </div>
                    </div>
                    <div class="spell-modal-description">
                        <h4>Description</h4>
                        <p>${spell.description || 'Aucune description disponible'}</p>
                    </div>
                    <div class="spell-modal-actions">
                        <button type="button" class="spell-modal-select-btn" onclick="toggleSpellFromModal('${spell.title}', event)">
                            ${selectedSpells.some(s => s.title === spell.title) ? 'D√©s√©lectionner ce sort' : 'S√©lectionner ce sort'}
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        modal.style.display = 'flex';
        
        // Fermer la modal en cliquant √† l'ext√©rieur
        modal.onclick = function(e) {
            if (e.target === modal) {
                closeSpellDetails();
            }
        };
    }

    // Fermer la modal de d√©tails
    function closeSpellDetails(event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const modal = document.getElementById('spellDetailsModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }

    // S√©lectionner/d√©s√©lectionner un sort depuis la modal
    function toggleSpellFromModal(spellTitle, event) {
        if (event) {
            event.preventDefault();
            event.stopPropagation();
        }
        
        const spell = availableSpells.find(s => s.title === spellTitle);
        if (!spell) return;
        
        const spellIndex = selectedSpells.findIndex(s => s.title === spellTitle);
        
        if (spellIndex === -1) {
            if (!canSelectSpell(spell)) {
                return;
            }
            selectedSpells.push(spell);
        } else {
            selectedSpells.splice(spellIndex, 1);
        }
        
        // Mettre √† jour l'affichage
        updateSelectedSpellsDisplay();
        updateSpellSelectionLimits();
        displaySpells(); // Rafra√Æchir la liste pour mettre √† jour les boutons
        
        // Mettre √† jour le bouton de la modal
        const modalBtn = document.querySelector('.spell-modal-select-btn');
        if (modalBtn) {
            modalBtn.textContent = selectedSpells.some(s => s.title === spellTitle) ? 'D√©s√©lectionner ce sort' : 'S√©lectionner ce sort';
        }
    }

    // Gestion de la s√©lection des sorts (ancienne version pour compatibilit√©)
    function toggleSpellSelection(spell, cardElement) {
        const spellIndex = selectedSpells.findIndex(s => s.title === spell.title);
        
        if (spellIndex === -1) {
            // V√©rifier les limitations avant d'ajouter
            if (!canSelectSpell(spell)) {
                return;
            }
            
            // Ajouter le sort
            selectedSpells.push(spell);
            cardElement.classList.add('selected');
        } else {
            // Retirer le sort
            selectedSpells.splice(spellIndex, 1);
            cardElement.classList.remove('selected');
        }
        
        updateSelectedSpellsDisplay();
        updateSpellSelectionLimits();
    }

    // V√©rifier si on peut s√©lectionner un sort
    function canSelectSpell(spell) {
        if (!spellLimitations) return true;
        
        const isCantrip = spell.level === 0;
        const currentCantrips = selectedSpells.filter(s => s.level === 0).length;
        const currentSpells = selectedSpells.filter(s => s.level > 0).length;
        
        if (isCantrip) {
            if (currentCantrips >= (spellLimitations.cantrips_known || 0)) {
                alert(`Vous ne pouvez conna√Ætre que ${spellLimitations.cantrips_known} tours de magie au niveau 1.`);
                return false;
            }
        } else {
            // Utiliser la bonne limite selon le type de classe
            const maxSpells = spellLimitations.prepares_spells ? 
                (spellLimitations.spells_preparable || 0) : 
                (spellLimitations.spells_known || 0);
            const actionText = spellLimitations.prepares_spells ? 'pr√©parer' : 'conna√Ætre';
            
            if (currentSpells >= maxSpells) {
                alert(`Vous ne pouvez ${actionText} que ${maxSpells} sorts au niveau 1.`);
                return false;
            }
        }
        
        return true;
    }

    // Mettre √† jour l'affichage des limites de s√©lection
    function updateSpellSelectionLimits() {
        const currentCantrips = selectedSpells.filter(s => s.level === 0).length;
        const currentSpells = selectedSpells.filter(s => s.level > 0).length;
        
        // Mettre √† jour l'en-t√™te avec les compteurs
        const header = document.querySelector('.spells-header h3');
        if (header && spellLimitations) {
            const maxCantrips = spellLimitations.cantrips_known || 0;
            // Utiliser spells_preparable pour les classes qui pr√©parent, sinon spells_known
            const maxSpells = spellLimitations.prepares_spells ? 
                (spellLimitations.spells_preparable || 0) : 
                (spellLimitations.spells_known || 0);
            const slots = Object.entries(spellLimitations.spell_slots || {})
                .map(([level, count]) => `${count} niv.${level}`)
                .join(', ');
            
            // Texte diff√©rent selon le type de classe
            const spellsLabel = spellLimitations.prepares_spells ? 'Sorts pr√©parables' : 'Sorts connus';
            
            header.innerHTML = `
                Sorts disponibles pour <span id="classNameForSpells">${selectedClass}</span>
                <div class="spell-limits">
                    <small>
                        Tours de magie: ${currentCantrips}/${maxCantrips} | 
                        ${spellsLabel}: ${currentSpells}/${maxSpells} | 
                        Emplacements: ${slots || 'aucun'}
                    </small>
                </div>
            `;
        }
    }

    // Filtrage des sorts
    function filterSpells() {
        const levelFilter = document.getElementById('spellLevelFilter').value;
        const schoolFilter = document.getElementById('spellSchoolFilter').value;
        
        document.querySelectorAll('.spell-card-compact').forEach(card => {
            const cardLevel = card.dataset.level;
            const cardSchool = card.dataset.school;
            
            const levelMatch = !levelFilter || cardLevel === levelFilter;
            const schoolMatch = !schoolFilter || cardSchool === schoolFilter;
            
            card.style.display = (levelMatch && schoolMatch) ? 'block' : 'none';
        });
    }

    // Mise √† jour de l'affichage des sorts s√©lectionn√©s
    function updateSelectedSpellsDisplay() {
        const container = document.getElementById('selectedSpellsList');
        
        if (selectedSpells.length === 0) {
            container.innerHTML = '<p class="empty-state">Aucun sort s√©lectionn√©</p>';
        } else {
            container.innerHTML = selectedSpells.map(spell => `
                <div class="selected-item">
                    <span>${spell.title} (Niveau ${spell.level === 0 ? 'Tour de magie' : spell.level})</span>
                    <button class="remove-item" onclick="removeSelectedSpell('${spell.title}')">√ó</button>
                </div>
            `).join('');
        }
        
        // Mettre √† jour le r√©sum√© du personnage
        updateCharacterSummary();
    }

    // Retirer un sort s√©lectionn√©
    function removeSelectedSpell(spellTitle) {
        const spellIndex = selectedSpells.findIndex(s => s.title === spellTitle);
        if (spellIndex !== -1) {
            selectedSpells.splice(spellIndex, 1);
            
            // Retirer la s√©lection visuelle
            document.querySelectorAll('.spell-card').forEach(card => {
                if (card.querySelector('.spell-title').textContent === spellTitle) {
                    card.classList.remove('selected');
                }
            });
            
            updateSelectedSpellsDisplay();
        }
    }

    // Variables pour la progression
    let progressionChoice = null;
    // Variables d√©j√† d√©clar√©es globalement
    let currentSubclassData = null;
    
    // Variables pour l'√©quipement
    // equipmentData d√©j√† d√©clar√© globalement
    let currentClass = null;
    let hasShield = false;
    let maxValue = 0;
    let maxWeight = 0;
    let currentValue = 0;
    let currentWeight = 0;
            // selectedInventory d√©j√† d√©clar√© globalement

    // Fonction nextStep modifi√©e pour g√©rer l'√©tape 4 et la popup de progression
    async function nextStep() {
        if (!validateCurrentStep()) {
            return;
        }
        
        if (currentStep === 3) {
            // Pour la cr√©ation de personnage, on assume niveau 1 par d√©faut
            // Mais on peut permettre de choisir un niveau plus √©lev√©
            const level = getCharacterLevel();
            const shouldShowProgression = await checkProgressionOptions(selectedClass, level);
            
            if (shouldShowProgression) {
                await showProgressionModal();
                return; // Attendre la s√©lection dans la popup
            }
            
            // Transition vers l'√©tape 4
            const success = await loadStep4Data();
            if (!success) return;
        }
        
        if (currentStep === 4) {
            // Charger les donn√©es d'√©quipement pour l'√©tape 5
            await loadEquipmentData();
        }
        
        if (currentStep === 5) {
            // Initialiser l'√©tape de finalisation
            initializeFinalizationStep();
        }
        
        if (currentStep < 6) {
            currentStep++;
            updateStepDisplay();
        }
    }

    // V√©rifier les options de progression disponibles
    async function checkProgressionOptions(characterClass, level) {
        try {
            const response = await fetch(`/api/character-options?class=${characterClass}&level=${level}`);
            const options = await response.json();
            
            return options.can_multiclass || options.can_choose_subclass;
        } catch (error) {
            console.error('Erreur lors de la v√©rification des options:', error);
            return false;
        }
    }

    // Obtenir le niveau du personnage (par d√©faut 1, mais peut √™tre modifi√©)
    function getCharacterLevel() {
        // Chercher le champ de niveau dans le formulaire
        const levelInput = document.getElementById('characterLevel') || 
                          document.getElementById('level') || 
                          document.querySelector('select[name="character_level"]') ||
                          document.querySelector('input[name="level"]');
        
        if (levelInput) {
            return parseInt(levelInput.value) || 1;
        }
        
        // Sinon, v√©rifier s'il y a un niveau stock√© quelque part
        if (window.characterLevel) {
            return window.characterLevel;
        }
        
        // Par d√©faut, niveau 1 pour un nouveau personnage
        return 1;
    }

    // Afficher la popup de progression
    async function showProgressionModal() {
        const level = getCharacterLevel();
        
        try {
            // Charger les options disponibles
            const response = await fetch(`/api/character-options?class=${selectedClass}&level=${level}`);
            const options = await response.json();
            
            // Afficher/masquer les options selon la disponibilit√©
            const subclassOption = document.getElementById('subclassOption');
            const multiclassOption = document.getElementById('multiclassOption');
            
            if (options.can_choose_subclass) {
                subclassOption.style.display = 'block';
                await loadSubclasses(selectedClass);
            } else {
                subclassOption.style.display = 'none';
            }
            
            if (options.can_multiclass) {
                multiclassOption.style.display = 'block';
                await loadMulticlassOptions();
            } else {
                multiclassOption.style.display = 'none';
            }
            
            // Afficher la popup
            document.getElementById('progressionChoiceModal').style.display = 'flex';
            
        } catch (error) {
            console.error('Erreur lors du chargement des options de progression:', error);
            // Continuer sans popup en cas d'erreur
            const success = await loadStep4Data();
            if (success) {
                currentStep++;
                updateStepDisplay();
            }
        }
    }

    // Charger les sous-classes disponibles
    async function loadSubclasses(characterClass) {
        try {
            const response = await fetch(`/api/subclasses/${characterClass}`);
            const data = await response.json();
            
            const container = document.getElementById('subclassesList');
            
            if (data.subclasses && data.subclasses.length > 0) {
                // Organiser les sous-classes en colonnes (4 par ligne)
                const subclassesHTML = data.subclasses.map(subclass => `
                    <div class="subclass-card-compact" onclick="selectSubclass('${subclass.name}')">
                        <div class="subclass-header">
                            <h6>${subclass.name}</h6>
                            ${subclass.abilities && subclass.abilities.length > 0 ? 
                                `<span class="abilities-count">${subclass.abilities.length} aptitudes</span>` : 
                                ''}
                        </div>
                        <div class="subclass-description">
                            <p>${subclass.description || 'Sp√©cialisation unique de cette classe.'}</p>
                        </div>
                        ${subclass.abilities && subclass.abilities.length > 0 ? `
                            <div class="subclass-abilities-preview">
                                <strong>Aptitudes principales :</strong>
                                <ul>
                                    ${subclass.abilities.slice(0, 2).map(ability => `
                                        <li><strong>${ability.name}</strong>${ability.level ? ` (niveau ${ability.level})` : ''}</li>
                                    `).join('')}
                                    ${subclass.abilities.length > 2 ? `<li><em>... et ${subclass.abilities.length - 2} autres</em></li>` : ''}
                                </ul>
                            </div>
                        ` : ''}
                        <div class="subclass-actions">
                            <button type="button" class="subclass-details-btn" onclick="showSubclassDetails('${subclass.name}', event)">
                                Voir d√©tails
                            </button>
                        </div>
                    </div>
                `).join('');
                
                container.innerHTML = `
                    <div class="subclasses-grid">
                        ${subclassesHTML}
                    </div>
                    <div class="subclass-info">
                        <p><strong>üí° Conseil :</strong> Chaque sous-classe offre des capacit√©s uniques qui d√©finissent votre style de jeu. Cliquez pour voir les d√©tails.</p>
                    </div>
                `;
            } else {
                container.innerHTML = '<p>Aucune sous-classe disponible</p>';
            }
            
        } catch (error) {
            console.error('Erreur lors du chargement des sous-classes:', error);
        }
    }

    // Charger les options de multiclassing
    async function loadMulticlassOptions() {
        try {
            const response = await fetch('/api/multiclass-options');
            const data = await response.json();
            
            const container = document.getElementById('multiclassList');
            
            // Filtrer les classes (exclure la classe actuelle)
            const availableClasses = data.classes.filter(cls => cls !== selectedClass);
            
            container.innerHTML = availableClasses.map(className => `
                <div class="multiclass-card" onclick="selectMulticlass('${className}')">
                    <h5>${className.charAt(0).toUpperCase() + className.slice(1)}</h5>
                    <p>Combiner avec votre ${selectedClass} pour plus de polyvalence</p>
                </div>
            `).join('');
            
        } catch (error) {
            console.error('Erreur lors du chargement des options de multiclassing:', error);
        }
    }

    // Choisir le type de progression
    function chooseProgression(type) {
        progressionChoice = type;
        
        // R√©initialiser les s√©lections
        selectedSubclass = null;
        selectedMulticlass = null;
        
        // Mettre √† jour l'interface
        document.querySelectorAll('.progression-option').forEach(option => {
            option.classList.remove('selected');
        });
        
        if (type === 'single') {
            document.getElementById('singleClassOption').classList.add('selected');
            document.getElementById('confirmProgressionBtn').disabled = false;
        } else {
            document.getElementById('confirmProgressionBtn').disabled = true;
        }
    }

    // S√©lectionner une sous-classe
    function selectSubclass(subclassName) {
        selectedSubclass = subclassName;
        progressionChoice = 'subclass';
        
        // Mettre √† jour l'interface
        document.querySelectorAll('.progression-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.getElementById('subclassOption').classList.add('selected');
        
        document.querySelectorAll('.subclass-card-compact').forEach(card => {
            card.classList.remove('selected');
        });
        event.target.closest('.subclass-card-compact').classList.add('selected');
        
        document.getElementById('confirmProgressionBtn').disabled = false;
        
        // Mettre √† jour le r√©sum√©
        updateCharacterSummary();
    }

    // S√©lectionner une classe pour multiclassing
    function selectMulticlass(className) {
        selectedMulticlass = className;
        progressionChoice = 'multiclass';
        
        // Mettre √† jour l'interface
        document.querySelectorAll('.progression-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.getElementById('multiclassOption').classList.add('selected');
        
        document.querySelectorAll('.multiclass-card').forEach(card => {
            card.classList.remove('selected');
        });
        event.target.closest('.multiclass-card').classList.add('selected');
        
        document.getElementById('confirmProgressionBtn').disabled = false;
        
        // Mettre √† jour le r√©sum√©
        updateCharacterSummary();
    }

    // Confirmer le choix de progression
    async function confirmProgression() {
        // Sauvegarder les choix (vous pouvez les stocker dans des champs cach√©s ou variables globales)
        console.log('Choix de progression:', {
            type: progressionChoice,
            subclass: selectedSubclass,
            multiclass: selectedMulticlass
        });
        
        // Fermer la popup
        closeProgressionModal();
        
        // Continuer vers l'√©tape 4
        const success = await loadStep4Data();
        if (success) {
            currentStep++;
            updateStepDisplay();
        }
    }

    // Fermer la popup de progression
    function closeProgressionModal() {
        document.getElementById('progressionChoiceModal').style.display = 'none';
        
        // R√©initialiser les s√©lections
        progressionChoice = null;
        selectedSubclass = null;
        selectedMulticlass = null;
        
        document.querySelectorAll('.progression-option').forEach(option => {
            option.classList.remove('selected');
        });
        document.querySelectorAll('.subclass-card-compact, .multiclass-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        document.getElementById('confirmProgressionBtn').disabled = true;
    }

    // Afficher les d√©tails d'une sous-classe
    async function showSubclassDetails(subclassName, event) {
        if (event) {
            event.stopPropagation();
        }
        
        try {
            const response = await fetch(`/api/subclasses/${selectedClass}`);
            const data = await response.json();
            
            const subclass = data.subclasses.find(sc => sc.name === subclassName);
            if (!subclass) return;
            
            currentSubclassData = subclass;
            
            // Remplir la modal
            document.getElementById('subclassDetailsTitle').textContent = subclass.name;
            document.getElementById('subclassDetailsDescription').textContent = subclass.description;
            
            // Afficher les aptitudes
            const abilitiesList = document.getElementById('subclassAbilitiesList');
            if (subclass.abilities && subclass.abilities.length > 0) {
                abilitiesList.innerHTML = subclass.abilities.map(ability => `
                    <div class="ability-detail">
                        <h5>${ability.name}${ability.level ? ` (Niveau ${ability.level})` : ''}</h5>
                        <p>${ability.description}</p>
                    </div>
                `).join('');
            } else {
                abilitiesList.innerHTML = '<p>Aucune aptitude sp√©cifique document√©e.</p>';
            }
            
            // Afficher la modal
            document.getElementById('subclassDetailsModal').style.display = 'flex';
            
        } catch (error) {
            console.error('Erreur lors du chargement des d√©tails:', error);
        }
    }

    // Fermer la modal de d√©tails
    function closeSubclassDetails() {
        document.getElementById('subclassDetailsModal').style.display = 'none';
        currentSubclassData = null;
    }

    // S√©lectionner une sous-classe depuis la modal de d√©tails
    function selectSubclassFromDetails() {
        if (currentSubclassData) {
            selectSubclass(currentSubclassData.name);
            closeSubclassDetails();
        }
    }

    // Mettre √† jour le r√©sum√© du personnage
    function updateCharacterSummary() {
        // Appeler la fonction de r√©sum√© existante qui g√®re la plupart des √©l√©ments
        updateSummary();
        
        // Ajouter les √©l√©ments sp√©cifiques qui ne sont pas dans updateSummary()
        updateProgressionSection();
        updateCombatStats();
        updateEquipmentSummary();
    }
    
    // G√©rer la section de progression magique
    function updateProgressionSection() {
        const progressionSection = document.getElementById('summaryProgression');
        const hasProgression = selectedSpells?.length > 0 || selectedSubclass || selectedMulticlass;
        
        if (hasProgression && progressionSection) {
            progressionSection.style.display = 'block';
            
            // Mettre √† jour les sorts
            const spellsElement = document.getElementById('summarySpells');
            if (spellsElement) {
                if (selectedSpells && selectedSpells.length > 0) {
                    const cantrips = selectedSpells.filter(s => s.level === 0).length;
                    const spells = selectedSpells.filter(s => s.level > 0).length;
                    spellsElement.textContent = `${cantrips} tours de magie, ${spells} sorts`;
                } else {
                    spellsElement.textContent = 'Aucun sort s√©lectionn√©';
                }
            }
            
            // Mettre √† jour la sous-classe
            const subclassItem = document.getElementById('summarySubclassItem');
            const subclassElement = document.getElementById('summarySubclass');
            if (selectedSubclass && subclassItem && subclassElement) {
                subclassItem.style.display = 'block';
                subclassElement.textContent = selectedSubclass;
            } else if (subclassItem) {
                subclassItem.style.display = 'none';
            }
            
            // Mettre √† jour le multiclassing
            const multiclassItem = document.getElementById('summaryMulticlassItem');
            const multiclassElement = document.getElementById('summaryMulticlass');
            if (selectedMulticlass && multiclassItem && multiclassElement) {
                multiclassItem.style.display = 'block';
                multiclassElement.textContent = selectedMulticlass.charAt(0).toUpperCase() + selectedMulticlass.slice(1);
            } else if (multiclassItem) {
                multiclassItem.style.display = 'none';
            }
        } else if (progressionSection) {
            progressionSection.style.display = 'none';
        }
    }

    // Fonction prevStep modifi√©e pour g√©rer l'√©tape 4
    function prevStep() {
        if (currentStep > 1) {
            currentStep--;
            updateStepDisplay();
        }
    }

    // Initialisation
    document.addEventListener('DOMContentLoaded', function() {
        // Calculer les co√ªts initiaux
        ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse', 'charisme'].forEach(ability => {
            const score = parseInt(document.getElementById(ability).value);
            usedPoints += pointCosts[score];
            updateModifier(ability, score);
        });
        updatePointsDisplay();

        // Ajouter des listeners pour les changements manuels
        ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse', 'charisme'].forEach(ability => {
            document.getElementById(ability).addEventListener('change', function() {
                const newValue = parseInt(this.value);
                if (newValue >= 8 && newValue <= 15) {
                    // Recalculer tous les co√ªts
                    usedPoints = 0;
                    ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse', 'charisme'].forEach(ab => {
                        const score = parseInt(document.getElementById(ab).value);
                        usedPoints += pointCosts[score];
                        updateModifier(ab, score);
                    });
                    
                    if (usedPoints > totalPoints) {
                        alert('Vous avez d√©pass√© vos points disponibles !');
                        this.value = this.defaultValue;
                        return;
                    }
                    
                    updatePointsDisplay();
                    updateCharacterSummary();
                }
            });
        });

        // Initialiser l'√©tape 4
        initializeStep4();
        
        // Ajouter un listener pour les changements de niveau
        const levelSelect = document.getElementById('characterLevel');
        if (levelSelect) {
            levelSelect.addEventListener('change', function() {
                updateCharacterSummary();
            });
        }
    });

    // Modal de d√©tails de sous-classe
    document.getElementById('selectSubclassFromModal').addEventListener('click', function() {
        const selectedSubclass = this.closest('.subclass-card-compact').dataset.name;
        document.getElementById('subclassDetailsTitle').textContent = selectedSubclass;
        document.getElementById('subclassDetailsDescription').textContent = `Description de la sous-classe ${selectedSubclass}`;
        document.getElementById('subclassAbilitiesList').innerHTML = `
            <li>Aptitude 1: Description de l'aptitude 1</li>
            <li>Aptitude 2: Description de l'aptitude 2</li>
            <!-- Ajoutez d'autres aptitudes selon les besoins -->
        `;
        document.getElementById('subclassDetailsModal').style.display = 'block';
    });

    // Fermer la modal de d√©tails de sous-classe
    document.getElementById('closeSubclassDetails').addEventListener('click', function() {
        document.getElementById('subclassDetailsModal').style.display = 'none';
    });

    // Gestion de l'aper√ßu d'image
    function setupImagePreview() {
        const imageUrlInput = document.getElementById('characterImageUrl');
        const previewSection = document.getElementById('imagePreviewSection');
        const previewImage = document.getElementById('characterImagePreview');

        if (imageUrlInput) {
            imageUrlInput.addEventListener('input', function() {
                const url = this.value.trim();
                if (url && isValidImageUrl(url)) {
                    previewImage.src = url;
                    previewImage.onload = function() {
                        previewSection.style.display = 'block';
                    };
                    previewImage.onerror = function() {
                        previewSection.style.display = 'none';
                        console.warn('Impossible de charger l\'image:', url);
                    };
                } else {
                    previewSection.style.display = 'none';
                }
            });
        }
    }

    // V√©rifier si l'URL est une image valide
    function isValidImageUrl(url) {
        try {
            const urlObj = new URL(url);
            const extension = urlObj.pathname.toLowerCase();
            return extension.match(/\.(jpg|jpeg|png|gif|webp|svg)$/);
        } catch {
            return false;
        }
    }

    // Supprimer l'aper√ßu d'image
    function removeImagePreview() {
        const imageUrlInput = document.getElementById('characterImageUrl');
        const previewSection = document.getElementById('imagePreviewSection');
        
        imageUrlInput.value = '';
        previewSection.style.display = 'none';
    }

    // Initialiser l'aper√ßu d'image quand on arrive √† l'√©tape 6
    function initializeFinalizationStep() {
        setupImagePreview();
        
        // Pr√©-remplir le nom du personnage si disponible
        const characterNameInput = document.getElementById('character_name');
        const summaryName = document.getElementById('summaryName');
        
        if (characterNameInput && summaryName && characterNameInput.value) {
            // Le nom est d√©j√† rempli, pas besoin de le changer
        }
    }

    // Fonctions pour le r√©sum√© am√©lior√©
    function updateCombatStats() {
        // Calculer les points de vie
        const level = getCharacterLevel();
        const conModifier = getModifier('constitution');
        const hitDie = getClassHitDie(selectedClass);
        const hitPoints = hitDie + conModifier + ((level - 1) * (Math.floor(hitDie / 2) + 1 + conModifier));
        document.getElementById('summaryHitPoints').textContent = hitPoints;

        // Calculer la classe d'armure
        const armorClass = calculateArmorClass();
        document.getElementById('summaryArmorClass').textContent = armorClass;

        // Initiative (modificateur de Dext√©rit√©)
        const initiative = getModifier('dexterite');
        document.getElementById('summaryInitiative').textContent = initiative >= 0 ? `+${initiative}` : initiative;

        // Bonus de ma√Ætrise bas√© sur le niveau
        const proficiencyBonus = Math.ceil(level / 4) + 1;
        document.getElementById('summaryProficiencyBonus').textContent = `+${proficiencyBonus}`;
    }

    function updateEquipmentSummary() {
        // Armes
        const weapons = [];
        ['mainWeaponSelect', 'secondaryWeaponSelect', 'backupWeaponSelect'].forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select && select.value) {
                weapons.push(select.value);
            }
        });
        document.getElementById('summaryWeaponsList').textContent = weapons.length > 0 ? weapons.join(', ') : 'Aucune arme s√©lectionn√©e';

        // Armure et bouclier
        const protection = [];
        const armorSelect = document.getElementById('armorSelect');
        const shieldSelect = document.getElementById('shieldSelect');
        if (armorSelect && armorSelect.value) protection.push(armorSelect.value);
        if (shieldSelect && shieldSelect.value) protection.push(shieldSelect.value);
        document.getElementById('summaryArmorList').textContent = protection.length > 0 ? protection.join(', ') : 'Aucune armure s√©lectionn√©e';

        // Inventaire
        const inventoryCount = selectedInventory.length;
        document.getElementById('summaryInventoryList').textContent = inventoryCount > 0 ? `${inventoryCount} objets s√©lectionn√©s` : 'Aucun objet s√©lectionn√©';

        // Totaux
        const totalValue = document.getElementById('equipmentTotalValue')?.textContent || '0 po';
        const totalWeight = document.getElementById('equipmentTotalWeight')?.textContent || '0 kg';
        document.getElementById('summaryTotalValue').textContent = totalValue;
        document.getElementById('summaryTotalWeight').textContent = totalWeight;
    }

    function updateFinalizationSummary() {
        // Informations de base
        const gender = document.getElementById('character_gender')?.value || '-';
        const alignment = document.getElementById('character_alignment')?.value || '-';
        const age = document.getElementById('character_age')?.value || '-';
        const height = document.getElementById('character_height')?.value || '-';
        const weight = document.getElementById('character_weight')?.value || '-';

        document.getElementById('summaryGender').textContent = gender;
        document.getElementById('summaryAlignment').textContent = alignment;
        document.getElementById('summaryAge').textContent = age;
        document.getElementById('summaryHeight').textContent = height;
        document.getElementById('summaryWeight').textContent = weight;

        // Apparence
        const eyes = document.getElementById('character_eyes')?.value || '-';
        const skin = document.getElementById('character_skin')?.value || '-';
        const hair = document.getElementById('character_hair')?.value || '-';

        document.getElementById('summaryEyes').textContent = eyes;
        document.getElementById('summarySkin').textContent = skin;
        document.getElementById('summaryHair').textContent = hair;

        // Image
        const imageUrl = document.getElementById('characterImageUrl')?.value;
        const imageSection = document.getElementById('summaryCharacterImage');
        const imagePreview = document.getElementById('summaryImagePreview');
        
        if (imageUrl && isValidImageUrl(imageUrl)) {
            imagePreview.src = imageUrl;
            imageSection.style.display = 'block';
        } else {
            imageSection.style.display = 'none';
        }

        // Afficher la section de finalisation
        document.getElementById('summaryFinalization').style.display = 'block';
    }

    // Fonctions utilitaires
    function getClassHitDie(className) {
        const hitDice = {
            'barbare': 12, 'guerrier': 10, 'paladin': 10, 'r√¥deur': 10,
            'barde': 8, 'clerc': 8, 'druide': 8, 'moine': 8, 'roublard': 8, 'sorcier': 8,
            'ensorceleur': 6, 'magicien': 6
        };
        return hitDice[className] || 8;
    }

    function calculateArmorClass() {
        let baseAC = 10;
        let dexModifier = getModifier('dexterite');
        
        const armorSelect = document.getElementById('armorSelect');
        if (armorSelect && armorSelect.value && equipmentData) {
            const armor = equipmentData.armors.find(a => a.name === armorSelect.value);
            if (armor) {
                const armorClass = parseInt(armor.armor_class);
                if (armor.type === 'L√©g√®re') {
                    baseAC = armorClass + dexModifier;
                } else if (armor.type === 'Interm√©diaire') {
                    baseAC = armorClass + Math.min(dexModifier, 2);
                } else if (armor.type === 'Lourde') {
                    baseAC = armorClass;
                }
            }
        } else {
            baseAC = 10 + dexModifier;
        }

        // Ajouter le bouclier
        const shieldSelect = document.getElementById('shieldSelect');
        if (shieldSelect && shieldSelect.value) {
            baseAC += 2;
        }

        return baseAC;
    }

    function getModifier(ability) {
        const score = parseInt(document.getElementById(ability)?.value || 10);
        return Math.floor((score - 10) / 2);
    }

    // Fonctions pour la modal finale
    function showFinalSummary() {
        updateFinalSummaryContent();
        document.getElementById('finalSummaryModal').style.display = 'flex';
    }

    function closeFinalSummary() {
        document.getElementById('finalSummaryModal').style.display = 'none';
    }

    function updateFinalSummaryContent() {
        // Informations de base
        const characterName = document.getElementById('characterName')?.value || 'Personnage sans nom';
        const level = getCharacterLevel();
        const classText = selectedClass ? `${selectedClass.charAt(0).toUpperCase() + selectedClass.slice(1)} niveau ${level}` : 'Classe non s√©lectionn√©e';
        const raceText = selectedRace || 'Race non s√©lectionn√©e';

        document.getElementById('finalCharacterName').textContent = characterName;
        document.getElementById('finalCharacterClass').textContent = classText;
        document.getElementById('finalCharacterRace').textContent = raceText;

        // Image du personnage
        const imageUrl = document.getElementById('characterImageUrl')?.value;
        const finalImage = document.getElementById('finalCharacterImage');
        const defaultPortrait = document.querySelector('#finalCharacterPortrait .default-portrait');
        
        if (imageUrl && isValidImageUrl(imageUrl)) {
            finalImage.src = imageUrl;
            finalImage.style.display = 'block';
            defaultPortrait.style.display = 'none';
        } else {
            finalImage.style.display = 'none';
            defaultPortrait.style.display = 'flex';
        }

        // Caract√©ristiques
        const abilities = ['force', 'dexterite', 'constitution', 'intelligence', 'sagesse', 'charisme'];
        const finalAbilities = document.getElementById('finalAbilities');
        finalAbilities.innerHTML = abilities.map(ability => {
            const score = parseInt(document.getElementById(ability)?.value || 10);
            const modifier = getModifier(ability);
            const modifierText = modifier >= 0 ? `+${modifier}` : modifier;
            return `<div class="ability-final"><span>${ability.substring(0, 3).toUpperCase()}</span><span>${score} (${modifierText})</span></div>`;
        }).join('');

        // Statistiques de combat
        updateCombatStats();
        document.getElementById('finalHitPoints').textContent = document.getElementById('summaryHitPoints').textContent;
        document.getElementById('finalArmorClass').textContent = document.getElementById('summaryArmorClass').textContent;
        document.getElementById('finalInitiative').textContent = document.getElementById('summaryInitiative').textContent;
        document.getElementById('finalSpeed').textContent = document.getElementById('summarySpeed').textContent;

        // Comp√©tences
        const classSkillsText = document.getElementById('summaryClassSkills')?.textContent || '';
        const backgroundSkillsText = document.getElementById('summaryBackgroundSkills')?.textContent || '';
        const allSkills = [classSkillsText, backgroundSkillsText].filter(s => s && s !== '-').join(', ');
        document.getElementById('finalSkills').textContent = allSkills || 'Aucune comp√©tence s√©lectionn√©e';

        // √âquipement
        document.getElementById('finalWeapons').textContent = document.getElementById('summaryWeaponsList').textContent;
        document.getElementById('finalArmor').textContent = document.getElementById('summaryArmorList').textContent;
        document.getElementById('finalTotalValue').textContent = document.getElementById('summaryTotalValue').textContent;
        document.getElementById('finalTotalWeight').textContent = document.getElementById('summaryTotalWeight').textContent;

        // V√©rifier s'il y a des sorts
        if (selectedSpells && selectedSpells.length > 0) {
            document.getElementById('spells-accordion').style.display = 'block';
            updateFinalSpellsDetails();
        }

        // D√©tails de personnalit√©
        updateFinalPersonalityDetails();
        updateFinalEquipmentDetails();
    }

    function updateFinalSpellsDetails() {
        const spellsDetails = document.getElementById('finalSpellsDetails');
        if (selectedSpells && selectedSpells.length > 0) {
            const cantrips = selectedSpells.filter(s => s.level === 0);
            const spells = selectedSpells.filter(s => s.level > 0);
            
            let content = '';
            if (cantrips.length > 0) {
                content += `<h5>Tours de magie (${cantrips.length})</h5><ul>`;
                cantrips.forEach(spell => content += `<li>${spell.name}</li>`);
                content += '</ul>';
            }
            if (spells.length > 0) {
                content += `<h5>Sorts (${spells.length})</h5><ul>`;
                spells.forEach(spell => content += `<li>${spell.name} (niveau ${spell.level})</li>`);
                content += '</ul>';
            }
            spellsDetails.innerHTML = content;
        }
    }

    function updateFinalPersonalityDetails() {
        const personalityDetails = document.getElementById('finalPersonalityDetails');
        let content = '';
        
        if (selectedBackground) {
            content += `<h5>Historique: ${selectedBackground}</h5>`;
        }
        
        if (selectedPersonality.trait) {
            content += `<p><strong>Trait de personnalit√©:</strong> ${selectedPersonality.trait}</p>`;
        }
        if (selectedPersonality.ideal) {
            content += `<p><strong>Id√©al:</strong> ${selectedPersonality.ideal}</p>`;
        }
        if (selectedPersonality.bond) {
            content += `<p><strong>Lien:</strong> ${selectedPersonality.bond}</p>`;
        }
        if (selectedPersonality.flaw) {
            content += `<p><strong>D√©faut:</strong> ${selectedPersonality.flaw}</p>`;
        }
        
        personalityDetails.innerHTML = content || '<p>Aucun d√©tail de personnalit√© d√©fini.</p>';
    }

    function updateFinalEquipmentDetails() {
        const equipmentDetails = document.getElementById('finalEquipmentDetails');
        let content = '';
        
        // Armes d√©taill√©es
        const weapons = [];
        ['mainWeaponSelect', 'secondaryWeaponSelect', 'backupWeaponSelect'].forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select && select.value && equipmentData) {
                const weapon = equipmentData.weapons.find(w => w.name === select.value);
                if (weapon) {
                    weapons.push(`${weapon.name} (${weapon.damage}, ${weapon.price})`);
                }
            }
        });
        
        if (weapons.length > 0) {
            content += '<h5>Armes</h5><ul>';
            weapons.forEach(weapon => content += `<li>${weapon}</li>`);
            content += '</ul>';
        }
        
        // Inventaire s√©lectionn√©
        if (selectedInventory.length > 0) {
            content += '<h5>Objets d\'inventaire</h5><ul>';
            selectedInventory.forEach(itemName => {
                const item = equipmentData?.equipment.find(e => e.name === itemName);
                if (item) {
                    content += `<li>${item.name} (${item.price}, ${item.weight})</li>`;
                }
            });
            content += '</ul>';
        }
        
        equipmentDetails.innerHTML = content || '<p>Aucun √©quipement s√©lectionn√©.</p>';
    }

    function toggleAccordion(targetId) {
        const content = document.getElementById(targetId);
        const isOpen = content.style.display === 'block';
        
        // Fermer tous les accord√©ons
        document.querySelectorAll('.accordion-content').forEach(acc => {
            acc.style.display = 'none';
        });
        
        // Ouvrir celui cliqu√© s'il √©tait ferm√©
        if (!isOpen) {
            content.style.display = 'block';
        }
    }

    function confirmCharacterCreation() {
        // Soumettre le formulaire
        document.getElementById('characterForm').submit();
    }

    // Modifier la fonction nextStep pour afficher la modal √† la fin
    const originalNextStep = nextStep;
    nextStep = function() {
        if (currentStep === 6) {
            // √Ä la fin de l'√©tape 6, afficher la modal de r√©sum√© final
            updateCombatStats();
            updateEquipmentSummary();
            updateFinalizationSummary();
            showFinalSummary();
        } else {
            originalNextStep();
        }
    };

    // Mettre √† jour le r√©sum√© √† chaque changement
    function updateAllSummaries() {
        updateCharacterSummary();
        if (currentStep === 6) {
            updateFinalizationSummary();
        }
    }

    // Ajouter des listeners pour mettre √† jour le r√©sum√©
    document.addEventListener('DOMContentLoaded', function() {
        // Listeners existants...
        
        // Nouveaux listeners pour le r√©sum√© am√©lior√©
        const equipmentSelects = ['armorSelect', 'shieldSelect', 'mainWeaponSelect', 'secondaryWeaponSelect', 'backupWeaponSelect'];
        equipmentSelects.forEach(selectId => {
            const select = document.getElementById(selectId);
            if (select) {
                select.addEventListener('change', updateAllSummaries);
            }
        });
        
        // Listeners pour les champs de finalisation
        const finalizationFields = ['character_gender', 'character_alignment', 'character_age', 'character_height', 'character_weight', 'character_eyes', 'character_skin', 'character_hair', 'characterImageUrl'];
        finalizationFields.forEach(fieldId => {
            const field = document.getElementById(fieldId);
            if (field) {
                field.addEventListener('input', updateFinalizationSummary);
            }
        });
    });
</script>
{% endblock %}